#!/bin/bash
_XPG=1
result=0
errcnt=0
tstcnt=0;
for x in @top_srcdir@/test/*.re; do
	tstcnt=$(($tstcnt+1))
	echo $x
	switches=`basename $x|sed -e 's/^.*\.\([^.]*\)\..*$/-\1/g' -e 's/^[^-].*//'g`
	# don't use the -o flag, since it makes it harder to diff.
	outname=@builddir@/test/`basename ${x%.re}.temp`
	difname=@builddir@/test/`basename ${x%.re}.diff`
	@builddir@/re2c $switches $x 2>&1 | sed -e "s,$x,`basename $x`,g" -e "s,/\* Generated by re2c .*\*/,/\* Generated by re2c \*/,g" > $outname
#	if diff -u -I '#line [0-9]*' ${x%.re}.c $outname > $difname; then
	if diff ${x%.re}.c $outname > $difname; then
		echo "Passed."
		rm $outname
	else
		echo "Failed: ${x%.re}.c ${x%.re}.temp differ."
		result=1
		errcnt=$(($errcnt+1))
	fi
	test -f ${x%.re}.diff -a ! -s $difname && rm -f $difname
done
if test $result = 0; then
	echo "All $tstcnt tests passed successfully."
else
	echo "Error: $errcnt out $tstcnt tests failed."
fi
exit $result
