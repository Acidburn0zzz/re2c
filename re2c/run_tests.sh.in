#!/bin/bash

# somewhat portable way to detect CPU count
detect_cpu_count () {
    if [ "$CPUS" = "" ]; then
        # Windows standard environment variable
        CPUS="$NUMBER_OF_PROCESSORS"
    fi
    if [ "$CPUS" = "" ]; then
        # Linux
        CPUS=`getconf _NPROCESSORS_ONLN 2>/dev/null`
    fi
    if [ "$CPUS" = "" ]; then
        # FreeBSD
        CPUS=`getconf NPROCESSORS_ONLN 2>/dev/null`
    fi
    if [ "$CPUS" = "" ]; then
        # nothing helped
        CPUS="1"
    fi
}

valgrind=""
wine=""
re2c="./re2c"
threads=`detect_cpu_count; echo $CPUS`
tests=()
for arg in $*
do
	case $arg in
		"--valgrind" ) valgrind=`which valgrind` ;;
		"--wine" )
			wine=`which wine`
			re2c="${re2c}.exe"
			;;
		"-j"* )
			number=${arg#-j}
			number_pattern='^[0-9]+$'
			if [[ $number =~ $number_pattern ]]
			then
				threads=$number
			fi
			;;
		* ) tests+=("$arg") ;;
	esac
done
echo "Running in ${threads} thread(s)"

test_srcdir="@top_srcdir@/test"
test_blddir="test_"`date +%y%m%d%H%M%S`
rm -rf $test_blddir && mkdir $test_blddir
[ ${#tests[@]} -ne 0 ] || tests=(`find $test_srcdir -name '*.re' | sort`)

tests_per_thread=$((${#tests[@]} / threads + 1))
packs=()
for ((i = 0; i < threads; i++))
do
	j=$((i * tests_per_thread))
	packs[$i]=${tests[@]:j:tests_per_thread}
done

if test ! -x "${re2c}"
then
	echo "Cannot find re2c executable (${re2c})."
	exit 1
fi

if test -n "${valgrind}"
then
	valgrind_options=(
		"-q"
		"--track-origins=yes"
		"--num-callers=50"
		"--leak-check=full"
		"--show-reachable=yes"
		"--malloc-fill=0xa1"
		"--free-fill=0xa1"
		)
	valgrind="${valgrind} ${valgrind_options[@]}"
	echo $valgrind
fi

run_pack() {
	local log="$1"
	shift 1

	local errcnt=0
	for x in $*
	do
		local switches=`basename $x | sed -e 's/^[^.]*\.\(.*\)\.re$/-\1/g' -e 's/^[^-].*//g' -e 's/\([^ ]\)--/\1 --/g' -e 's/(\([^)]*\))/ \1/g' -e 's/- //g'`
		local genname=` printf "%s" "$switches" | sed -e 's,--.*$,,g' -e 's,^.[^o]*$,,g' -e 's,^[^ot]*t.*o.*$,,g' -e 's,^-[^o]*o\(.*\),'"$test_blddir"'/\1,g'`
		local headers=` printf "%s" "$switches" | sed -e 's,--.*$,,g' -e 's,^.[^t]*$,,g' -e 's,^[^ot]*o.*t.*$,,g' -e 's,^-[^t]*t\(.*\),'"$test_blddir"'/\1,g'`
		local switches=`printf "%s" "$switches" | sed -e 's,^-\([^ot-]*[ot]\)\(.*\)$,-\1'"$test_blddir"'/\2,g'`
		# don't use the -o flag, since it makes it harder to diff.
		local outname=$test_blddir/`basename ${x%.re}.c.temp`
		local outdiff=$test_blddir/`basename ${x%.re}.c.diff`
		local typname=$test_blddir/`basename ${x%.re}.h.temp`
		local typdiff=$test_blddir/`basename ${x%.re}.h.diff`

		# enable warnings globally
		local switches="$switches -W"

		local cmd="${valgrind} ${wine} ${re2c} $switches $x"
		if test -n "${wine}"
		then
			local filter_newlines='-e s/\r//g'
		fi
		$cmd 2>&1 | LC_ALL=C sed -e "s,$x,`basename $x`,g" -e 's,/\* Generated by re2c .*\*/,/\* Generated by re2c \*/,g' ${filter_newlines} > $outname
		if test -n "$genname"
		then
			cat $genname | sed \
				-e 's,'"$test_srcdir"'/,,g' \
				-e 's,'"$test_blddir"'/,,g' \
				-e 's,/\* Generated by re2c .*\*/,/\* Generated by re2c \*/,g' \
				>> $outname
			rm $genname
		fi

		if test ! -f ${x%.re}.c
		then
			echo "FAIL missing ${x%.re}.c"
			local errcnt=$(($errcnt + 1))
			cp -f $x $test_blddir
		else
			local r=`diff ${x%.re}.c $outname > $outdiff; echo $?`
			if [[ $r == 0 ]]
			then
				echo "OK $x: $switches"
				rm $outname
			else
				echo "FAIL $x: $switches"
				local errcnt=$(($errcnt + 1))
				cp -f $x ${x%.re}.c $test_blddir
			fi
		fi

		if test -n "$headers"
		then
			cat $headers | sed -e 's,'"$test_blddir"'/,,g' -e 's,/\* Generated by re2c .*\*/,/\* Generated by re2c \*/,g' > $typname
			rm $headers
			if test ! -f ${x%.re}.h
			then
				echo "FAIL missing ${x%.re}.h"
				local errcnt=$(($errcnt + 1))
				cp -f $x $test_blddir
			elif diff ${x%.re}.h $typname > $typdiff
			then
				echo "OK $x: $switches"
				rm $typname
			else
				echo "FAIL $x: $switches"
				local errcnt=$(($errcnt + 1))
				cp -f $x ${x%.re}.h $test_blddir
			fi
		fi
		test -f $outdiff -a ! -s $outdiff && rm -f $outdiff
		test -f $typdiff -a ! -s $typdiff && rm -f $typdiff
	done
	echo $errcnt > $log
}

cleanup() {
	rm -f ${logs[@]}
	kill ${wait_pids[@]}
	wait ${wait_pids[@]}
	printf "\nEh...\n"
	exit 1
}

logs=()
wait_pids=()
trap cleanup INT
for ((i = 0; i < ${#packs[@]}; i++))
do
	logs[$i]=`date +%y%m%d%H%M%S`_$i
	run_pack ${logs[i]} ${packs[i]} &
	wait_pids+=( $! )
done
wait ${wait_pids[@]}

errors=0
for ((i = 0; i < ${#logs[@]}; i++))
do
	error=`cat ${logs[i]}`
	errors=$((errors + error))
	rm -f ${logs[i]}
done

if [ $errors -eq 0 ]
then
	echo "All ${#tests[@]} tests passed successfully."
	rm -r $test_blddir
	exit 0
else
	echo "Error: $errors out ${#tests[@]} tests failed."
	exit 1
fi
