
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Push model &#8212; re2c 1.1 documentation</title>
    <link rel="stylesheet" href="../_static/theme-re2c.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
    
 
  </head>
  <body>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="re2c-logo">
    re2c-1.1
</div>

<h3><a href="../index.html">Home</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manual/manual.html">Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="example_01.html">Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_02.html">Strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_03.html">Large input</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_04.html">Multiple blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_05.html">Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_08.html">IPv4 address</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_09.html">/etc/passwd</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_14.html">Options &amp; arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_13.html">Records &amp; structs</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_07.html">C++98</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_10.html">URI (RFC-3986)</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_11.html">HTTP (RFC-7230)</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_06.html">Braille patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_15.html">Strings in binaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_16.html">Fake sentinel</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_17.html">std::ifstream</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Push model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../news/news.html">News</a></li>
</ul>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="push-model">
<h1>Push model<a class="headerlink" href="#push-model" title="Permalink to this headline">¶</a></h1>
<p>By default re2c generates <em>pull-model</em> lexers:
it assumes that the lexer runs without interrupts and calls <code class="docutils literal"><span class="pre">YYFILL</span></code> to “pull” more input.
In some cases it might be necessary to generate a <em>push-model</em> lexer
that stops when it runs out of input and returns control to the outer program.
Later, when the outer program obtains more input, it resumes lexer and continues lexing from the point where it stopped.</p>
<p>In order to function in this manner lexer must be able to store its inner state before returning to the caller.
This can be done with re2c <code class="docutils literal"><span class="pre">-f</span></code> <code class="docutils literal"><span class="pre">--storable-state</span></code> option <a class="reference external" href="/manual/featires/state/state.html">described here</a>.
The example below reads chunks of input from <code class="docutils literal"><span class="pre">stdin</span></code> and counts the number of words in it.
Note that the parsing loop is located in the <code class="docutils literal"><span class="pre">main</span></code> function,
and <code class="docutils literal"><span class="pre">YYFILL</span></code> merely returns instead of refilling buffer.
Lexer state is represented with variables <code class="docutils literal"><span class="pre">state</span></code>, <code class="docutils literal"><span class="pre">yych</span></code> and <code class="docutils literal"><span class="pre">yyaccept</span></code>.
Dispatch on <code class="docutils literal"><span class="pre">state</span></code> is generated with the help of <code class="docutils literal"><span class="pre">/*!getstate:re2c*/</span></code> directive.
In this example explicit use of the directive is necessary, because we need to put entry code between state dispatch and lexer start.
If the directive is omitted, re2c emits state dispatch right before lexer start
(in this case <code class="docutils literal"><span class="pre">yy0</span></code> should be used as the start label).</p>
<p><a class="reference download internal" href="../_downloads/18_push_model.if.re" download=""><code class="xref download docutils literal"><span class="pre">[push_model.re]</span></code></a></p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cm">/*!max:re2c*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">input_t</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SIZE</span> <span class="o">+</span> <span class="n">YYMAXFILL</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">lim</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">need</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">yyaccept</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">yych</span><span class="p">;</span>

    <span class="n">input_t</span><span class="p">()</span>
        <span class="o">:</span> <span class="n">buf</span><span class="p">()</span>
        <span class="p">,</span> <span class="n">lim</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">SIZE</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">cur</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">tok</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">state</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">need</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">yyaccept</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">yych</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{}</span>

    <span class="kt">bool</span> <span class="n">fill</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">size_t</span> <span class="n">free</span> <span class="o">=</span> <span class="n">tok</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">need</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

        <span class="n">memmove</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">tok</span> <span class="o">+</span> <span class="n">SIZE</span><span class="p">);</span>
        <span class="n">lim</span> <span class="o">-=</span> <span class="n">free</span><span class="p">;</span>
        <span class="n">cur</span> <span class="o">-=</span> <span class="n">free</span><span class="p">;</span>
        <span class="n">tok</span> <span class="o">-=</span> <span class="n">free</span><span class="p">;</span>
        <span class="n">lim</span> <span class="o">+=</span> <span class="n">fread</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lim</span> <span class="o">&lt;</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">SIZE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YYMAXFILL</span><span class="p">);</span>
            <span class="n">lim</span> <span class="o">+=</span> <span class="n">YYMAXFILL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">status_t</span> <span class="p">{</span> <span class="n">OK</span><span class="p">,</span> <span class="n">FAIL</span><span class="p">,</span> <span class="n">NEED_MORE_INPUT</span> <span class="p">};</span>

<span class="k">static</span> <span class="n">status_t</span> <span class="nf">lex</span><span class="p">(</span><span class="n">input_t</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">&amp;</span><span class="n">words</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#   define YYGETSTATE()  in.state</span>
<span class="cp">#   define YYSETSTATE(s) in.state = s</span>
<span class="cp">#   define YYFILL(n)     do { in.need = n; return NEED_MORE_INPUT; } while (0)</span>
    <span class="cm">/*!getstate:re2c*/</span>
<span class="nl">loop</span><span class="p">:</span>
    <span class="n">in</span><span class="p">.</span><span class="n">tok</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">cur</span><span class="p">;</span>
    <span class="cm">/*!re2c</span>
<span class="cm">        re2c:define:YYCTYPE  = char;</span>
<span class="cm">        re2c:define:YYCURSOR = in.cur;</span>
<span class="cm">        re2c:define:YYLIMIT  = in.lim;</span>
<span class="cm">        re2c:variable:yych   = in.yych;</span>

<span class="cm">        *         { return FAIL; }</span>
<span class="cm">        [\x00]    { return OK; }</span>
<span class="cm">        [\n ]+    { goto loop; }</span>
<span class="cm">        [a-zA-Z]+ { ++words; goto loop; }</span>
<span class="cm">    */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">input_t</span> <span class="n">in</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">status_t</span> <span class="n">st</span> <span class="o">=</span> <span class="n">lex</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">words</span><span class="p">);</span>

        <span class="c1">// end of input: print result</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">word count: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">words</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">// unexpected error: abort</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="n">FAIL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// get more input and continue</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">.</span><span class="n">fill</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">small buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Compile:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ re2c --input custom -o push_model.cc push_model.re
$ g++ -o push_model push_model.cc
</pre></div>
</div>
<p>Run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ./push_model
Lorem ipsum dolor sit amet^D
word count: <span class="m">5</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
      Last updated on Aug 27, 2018.
    </div>
  </body>
</html>