<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Real-world examples</title>
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="alternate" type="application/atom+xml" href="/feed/atom.xml" title="Atom 1.0" />
<link rel="icon" href="/favicon.ico" />
</head>
<body>
<div class="document" id="real-world-examples">
<h1 class="title">Real-world examples</h1>

<p>The  best real-world example is a story of how <tt class="docutils literal"><span class="pre">[-Wcondition-order]</span></tt> was added to re2c.</p>
<p>One day I decided to change condition numbering scheme.
It was only natural: re2c assigns numbers to conditions in the order they appear in code.
This is not very convenient, because elsewhere in the code condition names (not numbers) are used as unique identifiers.
Names are sorted lexicographically, so the original condition order is not preserved.
It takes extra care to remember the mapping of names to numbers.
So why not just drop numbers and sort conditions by their names?
No one cares for condition order anyway: since re2c-generated code uses condition names,
they must be defined, and why would anyone define them by hand if they can do it automatically.</p>
<p>Or wait.
Almost occasionally I found a real-world program that does use fixed condition numbers.
Here is the carcass of this program:</p>
<pre class="code cpp literal-block">
<span class="ln"> 1 </span><span class="comment preproc">#define NORMAL 0
</span><span class="ln"> 2 </span><span class="comment preproc">#define PRE_RAW 1
</span><span class="ln"> 3 </span><span class="comment preproc">#define RAW 2
</span><span class="ln"> 4 </span><span class="comment preproc">#define INITIAL 3
</span><span class="ln"> 5 </span><span class="comment preproc"></span>
<span class="ln"> 6 </span><span class="comment multiline">/*!re2c
</span><span class="ln"> 7 </span><span class="comment multiline">    re2c:yyfill:check = 0;
</span><span class="ln"> 8 </span><span class="comment multiline">
</span><span class="ln"> 9 </span><span class="comment multiline">    T_TRUE      'true'
</span><span class="ln">10 </span><span class="comment multiline">    T_YES       'yes'
</span><span class="ln">11 </span><span class="comment multiline">    T_ON        'on'
</span><span class="ln">12 </span><span class="comment multiline">    T_ENABLED   'enabled'
</span><span class="ln">13 </span><span class="comment multiline">    T_FALSE     'false'
</span><span class="ln">14 </span><span class="comment multiline">    T_NO        'no'
</span><span class="ln">15 </span><span class="comment multiline">    T_OFF       'off'
</span><span class="ln">16 </span><span class="comment multiline">    T_DISABLED  'disabled'
</span><span class="ln">17 </span><span class="comment multiline">    T_EVAL      'ev'
</span><span class="ln">18 </span><span class="comment multiline">    T_SHELL     'sh'
</span><span class="ln">19 </span><span class="comment multiline">    T_IF        'if'
</span><span class="ln">20 </span><span class="comment multiline">    T_RUN       'run'
</span><span class="ln">21 </span><span class="comment multiline">    T_RUN_SHORT &quot;r&quot;
</span><span class="ln">22 </span><span class="comment multiline">    WS          [ \r\n\t]+
</span><span class="ln">23 </span><span class="comment multiline">    DIGITS      [-]?[0-9\.]+
</span><span class="ln">24 </span><span class="comment multiline">    ID          [^ \r\n\t:#\000]+
</span><span class="ln">25 </span><span class="comment multiline">    ADDR        [0][x][a-fA-F0-9]+
</span><span class="ln">26 </span><span class="comment multiline">    OPCODE      (ZEND_|zend_)([A-Za-z])+
</span><span class="ln">27 </span><span class="comment multiline">    INPUT       [^\n\000]+
</span><span class="ln">28 </span><span class="comment multiline">
</span><span class="ln">29 </span><span class="comment multiline">    &lt;!*&gt; {}
</span><span class="ln">30 </span><span class="comment multiline">    &lt;*&gt;{WS}?[\n\000] {}
</span><span class="ln">31 </span><span class="comment multiline">    &lt;PRE_RAW, NORMAL&gt;[-][r]{WS}?{DIGITS} {}
</span><span class="ln">32 </span><span class="comment multiline">    &lt;NORMAL&gt;{T_IF}{WS} {}
</span><span class="ln">33 </span><span class="comment multiline">    &lt;NORMAL&gt;{ID}[:]{1}[//]{2} {}
</span><span class="ln">34 </span><span class="comment multiline">    &lt;NORMAL&gt;[#]{1} {}
</span><span class="ln">35 </span><span class="comment multiline">    &lt;NORMAL&gt;[:]{2} {}
</span><span class="ln">36 </span><span class="comment multiline">    &lt;NORMAL&gt;[:]{1} {}
</span><span class="ln">37 </span><span class="comment multiline">    &lt;NORMAL&gt;({T_YES}|{T_ON}|{T_ENABLED}|{T_TRUE}){WS} {}
</span><span class="ln">38 </span><span class="comment multiline">    &lt;NORMAL&gt;({T_NO}|{T_OFF}|{T_DISABLED}|{T_FALSE}){WS} {}
</span><span class="ln">39 </span><span class="comment multiline">    &lt;NORMAL&gt;{DIGITS} {}
</span><span class="ln">40 </span><span class="comment multiline">    &lt;NORMAL&gt;{ADDR} {}
</span><span class="ln">41 </span><span class="comment multiline">    &lt;NORMAL&gt;{OPCODE} {}
</span><span class="ln">42 </span><span class="comment multiline">    &lt;NORMAL&gt;{ID} {}
</span><span class="ln">43 </span><span class="comment multiline">    &lt;RAW&gt;{INPUT} {}
</span><span class="ln">44 </span><span class="comment multiline">    &lt;*&gt;{WS} {}
</span><span class="ln">45 </span><span class="comment multiline">    &lt;INITIAL&gt;{T_EVAL}{WS} {}
</span><span class="ln">46 </span><span class="comment multiline">    &lt;INITIAL&gt;{T_SHELL}{WS} {}
</span><span class="ln">47 </span><span class="comment multiline">    &lt;INITIAL&gt;({T_RUN}|{T_RUN_SHORT}){WS} {}
</span><span class="ln">48 </span><span class="comment multiline">    &lt;PRE_RAW&gt;. {}
</span><span class="ln">49 </span><span class="comment multiline">    &lt;INITIAL&gt;. {}
</span><span class="ln">50 </span><span class="comment multiline">*/</span>
</pre>
<p>Curiously, the program somehow avoids using re2c-generated condition names:
even <tt class="docutils literal">YYSETCONDITION</tt> is called manually instead of using <tt class="docutils literal">=&gt;</tt> in rules.
The program uses <tt class="docutils literal"><span class="pre">-g</span></tt> option, so the initial dispatch does depend on condition order:</p>
<pre class="code cpp literal-block">
<span class="keyword">static</span> <span class="keyword type">void</span> <span class="operator">*</span><span class="name">yyctable</span><span class="punctuation">[</span><span class="literal number integer">4</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">{</span>
    <span class="operator">&amp;&amp;</span><span class="name">yyc_NORMAL</span><span class="punctuation">,</span>
    <span class="operator">&amp;&amp;</span><span class="name">yyc_PRE_RAW</span><span class="punctuation">,</span>
    <span class="operator">&amp;&amp;</span><span class="name">yyc_RAW</span><span class="punctuation">,</span>
    <span class="operator">&amp;&amp;</span><span class="name">yyc_INITIAL</span><span class="punctuation">,</span>
<span class="punctuation">};</span>
<span class="keyword">goto</span> <span class="operator">*</span><span class="name">yyctable</span><span class="punctuation">[</span><span class="name">YYGETCONDITION</span><span class="punctuation">()];</span>
</pre>
<p>Of course, re2c will keep to the old condition numbering scheme (at least in the nearest future).
Who wants to break the old code? <tt class="docutils literal">:)</tt></p>
</div>
</body>
</html>
