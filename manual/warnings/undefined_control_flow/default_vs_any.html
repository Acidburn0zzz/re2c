<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Difference between * and [^]</title>
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="alternate" type="application/atom+xml" href="/feed/atom.xml" title="Atom 1.0" />
<link rel="icon" href="/favicon.ico" />
</head>
<body>
<div class="document" id="difference-between-and">
<h1 class="title">Difference between <tt class="docutils literal">*</tt> and <tt class="docutils literal">[^]</tt></h1>

<p>When the the world was young and re2c didn't have default rule <tt class="docutils literal">*</tt> (that is, before re2c-0.13.7),
everyone used <tt class="docutils literal">[^]</tt> as default rule:</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span><span class="comment multiline">/*!re2c
</span><span class="ln">2 </span><span class="comment multiline">    // ... normal rules ...
</span><span class="ln">3 </span><span class="comment multiline">    [^] { return &quot;any&quot;; }
</span><span class="ln">4 </span><span class="comment multiline">*/</span>
</pre>
<p><tt class="docutils literal">[^]</tt> is just an ordinary rule: it matches any character and has normal priority (so it should be the last rule).
If other rules didn't match, <tt class="docutils literal">[^]</tt> will match and consume one character.</p>
<p>But exactly what is a <em>character</em>?
First, an abstract number that is assigned some sacred meaning in current encoding — <em>code point</em>.
Second, a minimal piece of information (say, combination of bits) that can represent a unit of encoded text — <em>code unit</em>.
Rules are defined in terms of code points.
Input is measured in code units.
In fixed-width encodings (such as ASCII, EBCDIC, UCS-2, UTF-32, etc.) there is one-to-one correspondence between code points and code units.
In variable-width encodings (such as UTF-8, UTF-16, etc.) code points map to code unit sequences of differing length.</p>
<p><tt class="docutils literal">[^]</tt> rule matches any code point.
In fixed-width encodings it covers all code units and consumes exactly one of them.
In variable-width encodings it consumes variable number of code units and may not match some of them.
The example above compiles without warnings with any fixed-width encoding (ASCII by default).
However, with UTF-8 encoding <tt class="docutils literal">`re2c <span class="pre">-i8</span> <span class="pre">-Wundefined-control-flow`</span></tt> says:</p>
<pre class="code literal-block">
re2c: warning: line 4: control flow is undefined for strings that match
        '[\x80-\xC1\xF5-\xFF]'
        '\xF0 [\x0-\x8F\xC0-\xFF]'
        '[\xE1-\xEF] [\x0-\x7F\xC0-\xFF]'
        '\xF4 [\x0-\x7F\x90-\xFF]'
        '\xE0 [\x0-\x9F\xC0-\xFF]'
        '[\xF1-\xF3] [\x0-\x7F\xC0-\xFF]'
        '[\xC2-\xDF] [\x0-\x7F\xC0-\xFF]'
        '\xE0 [\xA0-\xBF] [\x0-\x7F\xC0-\xFF]'
 ... and 7 more, use default rule '*' [-Wundefined-control-flow]
</pre>
<p>It shows us the patterns that must never appear in valid UTF-8 encoded text.
If the input is not valid UTF-8, lexer behaviour is undefined (most likely it will end up with segfault).
One would expect that with UTF-16 (another variable-width encoding) re2c will also report a warning, but it doesn't.
This is because by default re2c treats Unicode surrogates as normal code points (for backwards compatibility reasons).
If we tell re2c to exclude surrogates, <tt class="docutils literal">`re2c <span class="pre">-ix</span> <span class="pre">--encoding-policy</span> fail <span class="pre">-Wundefined-control-flow`</span></tt> will warn:</p>
<pre class="code literal-block">
re2c: warning: line 4: control flow is undefined for strings that match
        '[\xDC00-\xDFFF]'
        '[\xD800-\xDBFF] [\x0-\xDBFF\xE000-\xFFFF]'
, use default rule '*' [-Wundefined-control-flow]
</pre>
<p>As you see, it can get quite subtle.
One should always use the true default rule <tt class="docutils literal">*</tt> (it matches any code unit regardless of encoding,
consumes a single code unit no matter what and always has the lowest priority).
Note that <tt class="docutils literal">*</tt> is a builtin hack: it cannot be expressed through ordinary rules.</p>
</div>
</body>
</html>
