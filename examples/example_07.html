<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>C++98 lexer</title>
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="alternate" type="application/atom+xml" href="/feed/atom.xml" title="Atom 1.0" />
<link rel="icon" href="/favicon.ico" />
</head>
<body>
<div class="header">
<a class="reference external" href="../index.html">[home]</a> <a class="reference external" href="examples.html">[Examples]</a>
<hr class="header"/>
</div>
<div class="document" id="c-98-lexer">
<h1 class="title">C++98 lexer</h1>

<p>This is an example of a big real-world re2c program: C++98 lexer.
It confirms to the C++98 standard (except for a couple of hacks to simulate preprocessor).
All nontrivial lexemes (integers, floating-point constants, strings and character literals)
are parsed (not only recognized): numeric literals are converted to numbers, strings are unescaped.
Some additional checks described in standard (e.g. overflows in integer literals) are also done.
In fact, C++ is an easy language to lex: unlike many other languages, lexer can proceed without feedback from parser.</p>
<p><a class="reference external" href="07_cxx98.re">[07_cxx98.re]</a></p>
<pre class="code cpp literal-block">
<span class="ln">  1 </span><span class="comment preproc">#include &lt;float.h&gt;
</span><span class="ln">  2 </span><span class="comment preproc">#include &lt;limits.h&gt;
</span><span class="ln">  3 </span><span class="comment preproc">#include &lt;stdio.h&gt;
</span><span class="ln">  4 </span><span class="comment preproc">#include &lt;string.h&gt;
</span><span class="ln">  5 </span><span class="comment preproc"></span>
<span class="ln">  6 </span><span class="comment multiline">/*!max:re2c*/</span>
<span class="ln">  7 </span><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword type">size_t</span> <span class="name">SIZE</span> <span class="operator">=</span> <span class="literal number integer">64</span> <span class="operator">*</span> <span class="literal number integer">1024</span><span class="punctuation">;</span>
<span class="ln">  8 </span>
<span class="ln">  9 </span><span class="keyword">struct</span> <span class="keyword type">input_t</span> <span class="punctuation">{</span>
<span class="ln"> 10 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="name">buf</span><span class="punctuation">[</span><span class="name">SIZE</span> <span class="operator">+</span> <span class="name">YYMAXFILL</span><span class="punctuation">];</span>
<span class="ln"> 11 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">lim</span><span class="punctuation">;</span>
<span class="ln"> 12 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">cur</span><span class="punctuation">;</span>
<span class="ln"> 13 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">mar</span><span class="punctuation">;</span>
<span class="ln"> 14 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">tok</span><span class="punctuation">;</span>
<span class="ln"> 15 </span>    <span class="keyword type">bool</span> <span class="name">eof</span><span class="punctuation">;</span>
<span class="ln"> 16 </span>
<span class="ln"> 17 </span>    <span class="keyword type">FILE</span> <span class="operator">*</span><span class="keyword">const</span> <span class="name">file</span><span class="punctuation">;</span>
<span class="ln"> 18 </span>
<span class="ln"> 19 </span>    <span class="keyword type">input_t</span><span class="punctuation">(</span><span class="keyword type">FILE</span> <span class="operator">*</span><span class="name">f</span><span class="punctuation">)</span>
<span class="ln"> 20 </span>        <span class="operator">:</span> <span class="name">buf</span><span class="punctuation">()</span>
<span class="ln"> 21 </span>        <span class="punctuation">,</span> <span class="name">lim</span><span class="punctuation">(</span><span class="name">buf</span> <span class="operator">+</span> <span class="name">SIZE</span><span class="punctuation">)</span>
<span class="ln"> 22 </span>        <span class="punctuation">,</span> <span class="name">cur</span><span class="punctuation">(</span><span class="name">lim</span><span class="punctuation">)</span>
<span class="ln"> 23 </span>        <span class="punctuation">,</span> <span class="name">mar</span><span class="punctuation">(</span><span class="name">lim</span><span class="punctuation">)</span>
<span class="ln"> 24 </span>        <span class="punctuation">,</span> <span class="name">tok</span><span class="punctuation">(</span><span class="name">lim</span><span class="punctuation">)</span>
<span class="ln"> 25 </span>        <span class="punctuation">,</span> <span class="name">eof</span><span class="punctuation">(</span><span class="name builtin">false</span><span class="punctuation">)</span>
<span class="ln"> 26 </span>        <span class="punctuation">,</span> <span class="name">file</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">)</span>
<span class="ln"> 27 </span>    <span class="punctuation">{}</span>
<span class="ln"> 28 </span>    <span class="keyword type">bool</span> <span class="name">fill</span><span class="punctuation">(</span><span class="keyword type">size_t</span> <span class="name">need</span><span class="punctuation">)</span>
<span class="ln"> 29 </span>    <span class="punctuation">{</span>
<span class="ln"> 30 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">eof</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 31 </span>            <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 32 </span>        <span class="punctuation">}</span>
<span class="ln"> 33 </span>        <span class="keyword">const</span> <span class="keyword type">size_t</span> <span class="name">free</span> <span class="operator">=</span> <span class="name">tok</span> <span class="operator">-</span> <span class="name">buf</span><span class="punctuation">;</span>
<span class="ln"> 34 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">free</span> <span class="operator">&lt;</span> <span class="name">need</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 35 </span>            <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 36 </span>        <span class="punctuation">}</span>
<span class="ln"> 37 </span>        <span class="name">memmove</span><span class="punctuation">(</span><span class="name">buf</span><span class="punctuation">,</span> <span class="name">tok</span><span class="punctuation">,</span> <span class="name">lim</span> <span class="operator">-</span> <span class="name">tok</span><span class="punctuation">);</span>
<span class="ln"> 38 </span>        <span class="name">lim</span> <span class="operator">-=</span> <span class="name">free</span><span class="punctuation">;</span>
<span class="ln"> 39 </span>        <span class="name">cur</span> <span class="operator">-=</span> <span class="name">free</span><span class="punctuation">;</span>
<span class="ln"> 40 </span>        <span class="name">mar</span> <span class="operator">-=</span> <span class="name">free</span><span class="punctuation">;</span>
<span class="ln"> 41 </span>        <span class="name">tok</span> <span class="operator">-=</span> <span class="name">free</span><span class="punctuation">;</span>
<span class="ln"> 42 </span>        <span class="name">lim</span> <span class="operator">+=</span> <span class="name">fread</span><span class="punctuation">(</span><span class="name">lim</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="name">free</span><span class="punctuation">,</span> <span class="name">file</span><span class="punctuation">);</span>
<span class="ln"> 43 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">lim</span> <span class="operator">&lt;</span> <span class="name">buf</span> <span class="operator">+</span> <span class="name">SIZE</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 44 </span>            <span class="name">eof</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 45 </span>            <span class="name">memset</span><span class="punctuation">(</span><span class="name">lim</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name">YYMAXFILL</span><span class="punctuation">);</span>
<span class="ln"> 46 </span>            <span class="name">lim</span> <span class="operator">+=</span> <span class="name">YYMAXFILL</span><span class="punctuation">;</span>
<span class="ln"> 47 </span>        <span class="punctuation">}</span>
<span class="ln"> 48 </span>        <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 49 </span>    <span class="punctuation">}</span>
<span class="ln"> 50 </span><span class="punctuation">};</span>
<span class="ln"> 51 </span>
<span class="ln"> 52 </span><span class="comment multiline">/*!re2c re2c:define:YYCTYPE = &quot;unsigned char&quot;; */</span>
<span class="ln"> 53 </span>
<span class="ln"> 54 </span><span class="keyword">template</span><span class="operator">&lt;</span><span class="keyword type">int</span> <span class="name">base</span><span class="operator">&gt;</span>
<span class="ln"> 55 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">adddgt</span><span class="punctuation">(</span><span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="operator">&amp;</span><span class="name">u</span><span class="punctuation">,</span> <span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="name">d</span><span class="punctuation">)</span>
<span class="ln"> 56 </span><span class="punctuation">{</span>
<span class="ln"> 57 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">u</span> <span class="operator">&gt;</span> <span class="punctuation">(</span><span class="name">ULONG_MAX</span> <span class="operator">-</span> <span class="name">d</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="name">base</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 58 </span>        <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 59 </span>    <span class="punctuation">}</span>
<span class="ln"> 60 </span>    <span class="name">u</span> <span class="operator">=</span> <span class="name">u</span> <span class="operator">*</span> <span class="name">base</span> <span class="operator">+</span> <span class="name">d</span><span class="punctuation">;</span>
<span class="ln"> 61 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 62 </span><span class="punctuation">}</span>
<span class="ln"> 63 </span>
<span class="ln"> 64 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex_oct</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">e</span><span class="punctuation">,</span> <span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="operator">&amp;</span><span class="name">u</span><span class="punctuation">)</span>
<span class="ln"> 65 </span><span class="punctuation">{</span>
<span class="ln"> 66 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">u</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="operator">++</span><span class="name">s</span><span class="punctuation">;</span> <span class="name">s</span> <span class="operator">&lt;</span> <span class="name">e</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">s</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 67 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">adddgt</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="operator">&gt;</span><span class="punctuation">(</span><span class="name">u</span><span class="punctuation">,</span> <span class="operator">*</span><span class="name">s</span> <span class="operator">-</span> <span class="literal number hex">0x30u</span><span class="punctuation">))</span> <span class="punctuation">{</span>
<span class="ln"> 68 </span>            <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 69 </span>        <span class="punctuation">}</span>
<span class="ln"> 70 </span>    <span class="punctuation">}</span>
<span class="ln"> 71 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 72 </span><span class="punctuation">}</span>
<span class="ln"> 73 </span>
<span class="ln"> 74 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex_dec</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">e</span><span class="punctuation">,</span> <span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="operator">&amp;</span><span class="name">u</span><span class="punctuation">)</span>
<span class="ln"> 75 </span><span class="punctuation">{</span>
<span class="ln"> 76 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">u</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">s</span> <span class="operator">&lt;</span> <span class="name">e</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">s</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 77 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">adddgt</span><span class="operator">&lt;</span><span class="literal number integer">10</span><span class="operator">&gt;</span><span class="punctuation">(</span><span class="name">u</span><span class="punctuation">,</span> <span class="operator">*</span><span class="name">s</span> <span class="operator">-</span> <span class="literal number hex">0x30u</span><span class="punctuation">))</span> <span class="punctuation">{</span>
<span class="ln"> 78 </span>            <span class="keyword">return</span> <span class="name builtin">false</span><span class="punctuation">;</span>
<span class="ln"> 79 </span>        <span class="punctuation">}</span>
<span class="ln"> 80 </span>    <span class="punctuation">}</span>
<span class="ln"> 81 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 82 </span><span class="punctuation">}</span>
<span class="ln"> 83 </span>
<span class="ln"> 84 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex_hex</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">,</span> <span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">e</span><span class="punctuation">,</span> <span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="operator">&amp;</span><span class="name">u</span><span class="punctuation">)</span>
<span class="ln"> 85 </span><span class="punctuation">{</span>
<span class="ln"> 86 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">u</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name">s</span> <span class="operator">+=</span> <span class="literal number integer">2</span><span class="punctuation">;</span> <span class="name">s</span> <span class="operator">&lt;</span> <span class="name">e</span><span class="punctuation">;)</span> <span class="punctuation">{</span>
<span class="ln"> 87 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln"> 88 </span><span class="comment multiline">        re2c:yyfill:enable = 0;
</span><span class="ln"> 89 </span><span class="comment multiline">        re2c:define:YYCURSOR = s;
</span><span class="ln"> 90 </span><span class="comment multiline">        *     { if (!adddgt&lt;16&gt;(u, s[-1] - 0x30u))      return false; continue; }
</span><span class="ln"> 91 </span><span class="comment multiline">        [a-f] { if (!adddgt&lt;16&gt;(u, s[-1] - 0x61u + 10)) return false; continue; }
</span><span class="ln"> 92 </span><span class="comment multiline">        [A-F] { if (!adddgt&lt;16&gt;(u, s[-1] - 0x41u + 10)) return false; continue; }
</span><span class="ln"> 93 </span><span class="comment multiline">    */</span>
<span class="ln"> 94 </span>    <span class="punctuation">}</span>
<span class="ln"> 95 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln"> 96 </span><span class="punctuation">}</span>
<span class="ln"> 97 </span>
<span class="ln"> 98 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex_str</span><span class="punctuation">(</span><span class="keyword type">input_t</span> <span class="operator">&amp;</span><span class="name">in</span><span class="punctuation">,</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="name">q</span><span class="punctuation">)</span>
<span class="ln"> 99 </span><span class="punctuation">{</span>
<span class="ln">100 </span>    <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;%c&quot;</span><span class="punctuation">,</span> <span class="name">q</span><span class="punctuation">);</span>
<span class="ln">101 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="name">u</span> <span class="operator">=</span> <span class="name">q</span><span class="punctuation">;;</span> <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;</span><span class="literal string escape">\\</span><span class="literal string">x%lx&quot;</span><span class="punctuation">,</span> <span class="name">u</span><span class="punctuation">))</span> <span class="punctuation">{</span>
<span class="ln">102 </span>        <span class="name">in</span><span class="punctuation">.</span><span class="name">tok</span> <span class="operator">=</span> <span class="name">in</span><span class="punctuation">.</span><span class="name">cur</span><span class="punctuation">;</span>
<span class="ln">103 </span>        <span class="comment multiline">/*!re2c
</span><span class="ln">104 </span><span class="comment multiline">            re2c:define:YYCURSOR = in.cur;
</span><span class="ln">105 </span><span class="comment multiline">            re2c:define:YYMARKER = in.mar;
</span><span class="ln">106 </span><span class="comment multiline">            re2c:define:YYLIMIT = in.lim;
</span><span class="ln">107 </span><span class="comment multiline">            re2c:yyfill:enable = 1;
</span><span class="ln">108 </span><span class="comment multiline">            re2c:define:YYFILL = &quot;if (!in.fill(&#64;&#64;)) return false;&quot;;
</span><span class="ln">109 </span><span class="comment multiline">            re2c:define:YYFILL:naked = 1;
</span><span class="ln">110 </span><span class="comment multiline">            *                    { return false; }
</span><span class="ln">111 </span><span class="comment multiline">            [^\n\\]              { u = in.tok[0]; if (u == q) break; continue; }
</span><span class="ln">112 </span><span class="comment multiline">            &quot;\\a&quot;                { u = '\a'; continue; }
</span><span class="ln">113 </span><span class="comment multiline">            &quot;\\b&quot;                { u = '\b'; continue; }
</span><span class="ln">114 </span><span class="comment multiline">            &quot;\\f&quot;                { u = '\f'; continue; }
</span><span class="ln">115 </span><span class="comment multiline">            &quot;\\n&quot;                { u = '\n'; continue; }
</span><span class="ln">116 </span><span class="comment multiline">            &quot;\\r&quot;                { u = '\r'; continue; }
</span><span class="ln">117 </span><span class="comment multiline">            &quot;\\t&quot;                { u = '\t'; continue; }
</span><span class="ln">118 </span><span class="comment multiline">            &quot;\\v&quot;                { u = '\v'; continue; }
</span><span class="ln">119 </span><span class="comment multiline">            &quot;\\\\&quot;               { u = '\\'; continue; }
</span><span class="ln">120 </span><span class="comment multiline">            &quot;\\'&quot;                { u = '\''; continue; }
</span><span class="ln">121 </span><span class="comment multiline">            &quot;\\\&quot;&quot;               { u = '&quot;';  continue; }
</span><span class="ln">122 </span><span class="comment multiline">            &quot;\\?&quot;                { u = '?';  continue; }
</span><span class="ln">123 </span><span class="comment multiline">            &quot;\\&quot; [0-7]{1,3}      { lex_oct(in.tok, in.cur, u); continue; }
</span><span class="ln">124 </span><span class="comment multiline">            &quot;\\u&quot; [0-9a-fA-F]{4} { lex_hex(in.tok, in.cur, u); continue; }
</span><span class="ln">125 </span><span class="comment multiline">            &quot;\\U&quot; [0-9a-fA-F]{8} { lex_hex(in.tok, in.cur, u); continue; }
</span><span class="ln">126 </span><span class="comment multiline">            &quot;\\x&quot; [0-9a-fA-F]+   { if (!lex_hex(in.tok, in.cur, u)) return false; continue; }
</span><span class="ln">127 </span><span class="comment multiline">        */</span>
<span class="ln">128 </span>    <span class="punctuation">}</span>
<span class="ln">129 </span>    <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;%c&quot;</span><span class="punctuation">,</span> <span class="name">q</span><span class="punctuation">);</span>
<span class="ln">130 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">131 </span><span class="punctuation">}</span>
<span class="ln">132 </span>
<span class="ln">133 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex_flt</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="keyword type">unsigned</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">s</span><span class="punctuation">)</span>
<span class="ln">134 </span><span class="punctuation">{</span>
<span class="ln">135 </span>    <span class="keyword type">double</span> <span class="name">d</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">136 </span>    <span class="keyword type">double</span> <span class="name">x</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">137 </span>    <span class="keyword type">int</span> <span class="name">e</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">138 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">139 </span><span class="comment multiline">        re2c:yyfill:enable = 0;
</span><span class="ln">140 </span><span class="comment multiline">        re2c:define:YYCURSOR = s;
</span><span class="ln">141 </span><span class="comment multiline">    */</span>
<span class="ln">142 </span><span class="name label">mant_int</span><span class="punctuation">:</span>
<span class="ln">143 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">144 </span><span class="comment multiline">        &quot;.&quot;   { goto mant_frac; }
</span><span class="ln">145 </span><span class="comment multiline">        [eE]  { goto exp_sign; }
</span><span class="ln">146 </span><span class="comment multiline">        *     { d = (d * 10) + (s[-1] - '0'); goto mant_int; }
</span><span class="ln">147 </span><span class="comment multiline">    */</span>
<span class="ln">148 </span><span class="name label">mant_frac</span><span class="punctuation">:</span>
<span class="ln">149 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">150 </span><span class="comment multiline">        &quot;&quot;    { goto sfx; }
</span><span class="ln">151 </span><span class="comment multiline">        [eE]  { goto exp_sign; }
</span><span class="ln">152 </span><span class="comment multiline">        [0-9] { d += (x /= 10) * (s[-1] - '0'); goto mant_frac; }
</span><span class="ln">153 </span><span class="comment multiline">    */</span>
<span class="ln">154 </span><span class="name label">exp_sign</span><span class="punctuation">:</span>
<span class="ln">155 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">156 </span><span class="comment multiline">        &quot;+&quot;?  { x = 1e+1; goto exp; }
</span><span class="ln">157 </span><span class="comment multiline">        &quot;-&quot;   { x = 1e-1; goto exp; }
</span><span class="ln">158 </span><span class="comment multiline">    */</span>
<span class="ln">159 </span><span class="name label">exp</span><span class="punctuation">:</span>
<span class="ln">160 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">161 </span><span class="comment multiline">        &quot;&quot;    { for (; e &gt; 0; --e) d *= x;    goto sfx; }
</span><span class="ln">162 </span><span class="comment multiline">        [0-9] { e = (e * 10) + (s[-1] - '0'); goto exp; }
</span><span class="ln">163 </span><span class="comment multiline">    */</span>
<span class="ln">164 </span><span class="name label">sfx</span><span class="punctuation">:</span>
<span class="ln">165 </span>    <span class="comment multiline">/*!re2c
</span><span class="ln">166 </span><span class="comment multiline">        *     { goto end; }
</span><span class="ln">167 </span><span class="comment multiline">        [fF]  { if (d &gt; FLT_MAX) return false; goto end; }
</span><span class="ln">168 </span><span class="comment multiline">    */</span>
<span class="ln">169 </span><span class="name label">end</span><span class="punctuation">:</span>
<span class="ln">170 </span>    <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;%g&quot;</span><span class="punctuation">,</span> <span class="name">d</span><span class="punctuation">);</span>
<span class="ln">171 </span>    <span class="keyword">return</span> <span class="name builtin">true</span><span class="punctuation">;</span>
<span class="ln">172 </span><span class="punctuation">}</span>
<span class="ln">173 </span>
<span class="ln">174 </span><span class="keyword">static</span> <span class="keyword type">bool</span> <span class="name">lex</span><span class="punctuation">(</span><span class="keyword type">input_t</span> <span class="operator">&amp;</span><span class="name">in</span><span class="punctuation">)</span>
<span class="ln">175 </span><span class="punctuation">{</span>
<span class="ln">176 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">long</span> <span class="name">u</span><span class="punctuation">;</span>
<span class="ln">177 </span>    <span class="keyword">for</span> <span class="punctuation">(;;)</span> <span class="punctuation">{</span>
<span class="ln">178 </span>        <span class="name">in</span><span class="punctuation">.</span><span class="name">tok</span> <span class="operator">=</span> <span class="name">in</span><span class="punctuation">.</span><span class="name">cur</span><span class="punctuation">;</span>
<span class="ln">179 </span>        <span class="comment multiline">/*!re2c
</span><span class="ln">180 </span><span class="comment multiline">            re2c:define:YYCURSOR = in.cur;
</span><span class="ln">181 </span><span class="comment multiline">            re2c:define:YYMARKER = in.mar;
</span><span class="ln">182 </span><span class="comment multiline">            re2c:define:YYLIMIT = in.lim;
</span><span class="ln">183 </span><span class="comment multiline">            re2c:yyfill:enable = 1;
</span><span class="ln">184 </span><span class="comment multiline">            re2c:define:YYFILL = &quot;if (!in.fill(&#64;&#64;)) return false;&quot;;
</span><span class="ln">185 </span><span class="comment multiline">            re2c:define:YYFILL:naked = 1;
</span><span class="ln">186 </span><span class="comment multiline">
</span><span class="ln">187 </span><span class="comment multiline">            end = &quot;\x00&quot;;
</span><span class="ln">188 </span><span class="comment multiline">
</span><span class="ln">189 </span><span class="comment multiline">            *   { return false; }
</span><span class="ln">190 </span><span class="comment multiline">            end { return in.lim - in.tok == YYMAXFILL; }
</span><span class="ln">191 </span><span class="comment multiline">
</span><span class="ln">192 </span><span class="comment multiline">            // macros
</span><span class="ln">193 </span><span class="comment multiline">            macro = (&quot;#&quot; | &quot;%:&quot;) ([^\n] | &quot;\\\n&quot;)* &quot;\n&quot;;
</span><span class="ln">194 </span><span class="comment multiline">            macro { continue; }
</span><span class="ln">195 </span><span class="comment multiline">
</span><span class="ln">196 </span><span class="comment multiline">            // whitespaces
</span><span class="ln">197 </span><span class="comment multiline">            mcm = &quot;/*&quot; ([^*] | (&quot;*&quot; [^/]))* &quot;*&quot;&quot;/&quot;;
</span><span class="ln">198 </span><span class="comment multiline">            scm = &quot;//&quot; [^\n]* &quot;\n&quot;;
</span><span class="ln">199 </span><span class="comment multiline">            wsp = ([ \t\v\n\r] | scm | mcm)+;
</span><span class="ln">200 </span><span class="comment multiline">            wsp { printf(&quot; &quot;); continue; }
</span><span class="ln">201 </span><span class="comment multiline">
</span><span class="ln">202 </span><span class="comment multiline">            // character and string literals
</span><span class="ln">203 </span><span class="comment multiline">            &quot;L&quot;? ['&quot;] { if (!lex_str(in, in.cur[-1])) return false; continue; }
</span><span class="ln">204 </span><span class="comment multiline">            &quot;L&quot;? &quot;''&quot; { return false; }
</span><span class="ln">205 </span><span class="comment multiline">
</span><span class="ln">206 </span><span class="comment multiline">            // integer literals
</span><span class="ln">207 </span><span class="comment multiline">            oct = &quot;0&quot; [0-7]*;
</span><span class="ln">208 </span><span class="comment multiline">            dec = [1-9][0-9]*;
</span><span class="ln">209 </span><span class="comment multiline">            hex = '0x' [0-9a-fA-F]+;
</span><span class="ln">210 </span><span class="comment multiline">            oct { if (!lex_oct(in.tok, in.cur, u)) return false; goto sfx; }
</span><span class="ln">211 </span><span class="comment multiline">            dec { if (!lex_dec(in.tok, in.cur, u)) return false; goto sfx; }
</span><span class="ln">212 </span><span class="comment multiline">            hex { if (!lex_hex(in.tok, in.cur, u)) return false; goto sfx; }
</span><span class="ln">213 </span><span class="comment multiline">
</span><span class="ln">214 </span><span class="comment multiline">            // floating literals
</span><span class="ln">215 </span><span class="comment multiline">            frc = [0-9]* &quot;.&quot; [0-9]+ | [0-9]+ &quot;.&quot;;
</span><span class="ln">216 </span><span class="comment multiline">            exp = 'e' [+-]? [0-9]+;
</span><span class="ln">217 </span><span class="comment multiline">            flt = (frc exp? | [0-9]+ exp) [fFlL]?;
</span><span class="ln">218 </span><span class="comment multiline">            flt { if (lex_flt(in.tok)) continue; return false; }
</span><span class="ln">219 </span><span class="comment multiline">
</span><span class="ln">220 </span><span class="comment multiline">            // boolean literals
</span><span class="ln">221 </span><span class="comment multiline">            &quot;false&quot; { printf(&quot;false&quot;); continue; }
</span><span class="ln">222 </span><span class="comment multiline">            &quot;true&quot;  { printf(&quot;true&quot;);  continue; }
</span><span class="ln">223 </span><span class="comment multiline">
</span><span class="ln">224 </span><span class="comment multiline">            // keywords
</span><span class="ln">225 </span><span class="comment multiline">            &quot;asm&quot;              { printf(&quot;ASM&quot;);              continue; }
</span><span class="ln">226 </span><span class="comment multiline">            &quot;auto&quot;             { printf(&quot;AUTO&quot;);             continue; }
</span><span class="ln">227 </span><span class="comment multiline">            &quot;bool&quot;             { printf(&quot;BOOL&quot;);             continue; }
</span><span class="ln">228 </span><span class="comment multiline">            &quot;break&quot;            { printf(&quot;BREAK&quot;);            continue; }
</span><span class="ln">229 </span><span class="comment multiline">            &quot;case&quot;             { printf(&quot;CASE&quot;);             continue; }
</span><span class="ln">230 </span><span class="comment multiline">            &quot;catch&quot;            { printf(&quot;CATCH&quot;);            continue; }
</span><span class="ln">231 </span><span class="comment multiline">            &quot;char&quot;             { printf(&quot;CHAR&quot;);             continue; }
</span><span class="ln">232 </span><span class="comment multiline">            &quot;class&quot;            { printf(&quot;CLASS&quot;);            continue; }
</span><span class="ln">233 </span><span class="comment multiline">            &quot;const&quot;            { printf(&quot;CONST&quot;);            continue; }
</span><span class="ln">234 </span><span class="comment multiline">            &quot;const_cast&quot;       { printf(&quot;CONST_CAST&quot;);       continue; }
</span><span class="ln">235 </span><span class="comment multiline">            &quot;continue&quot;         { printf(&quot;CONTINUE&quot;);         continue; }
</span><span class="ln">236 </span><span class="comment multiline">            &quot;default&quot;          { printf(&quot;DEFAULT&quot;);          continue; }
</span><span class="ln">237 </span><span class="comment multiline">            &quot;do&quot;               { printf(&quot;DO&quot;);               continue; }
</span><span class="ln">238 </span><span class="comment multiline">            &quot;double&quot;           { printf(&quot;DOUBLE&quot;);           continue; }
</span><span class="ln">239 </span><span class="comment multiline">            &quot;dynamic_cast&quot;     { printf(&quot;DYNAMIC_CAST&quot;);     continue; }
</span><span class="ln">240 </span><span class="comment multiline">            &quot;else&quot;             { printf(&quot;ELSE&quot;);             continue; }
</span><span class="ln">241 </span><span class="comment multiline">            &quot;enum&quot;             { printf(&quot;ENUM&quot;);             continue; }
</span><span class="ln">242 </span><span class="comment multiline">            &quot;explicit&quot;         { printf(&quot;EXPLICIT&quot;);         continue; }
</span><span class="ln">243 </span><span class="comment multiline">            &quot;export&quot;           { printf(&quot;EXPORT&quot;);           continue; }
</span><span class="ln">244 </span><span class="comment multiline">            &quot;extern&quot;           { printf(&quot;EXTERN&quot;);           continue; }
</span><span class="ln">245 </span><span class="comment multiline">            &quot;float&quot;            { printf(&quot;FLOAT&quot;);            continue; }
</span><span class="ln">246 </span><span class="comment multiline">            &quot;for&quot;              { printf(&quot;FOR&quot;);              continue; }
</span><span class="ln">247 </span><span class="comment multiline">            &quot;friend&quot;           { printf(&quot;FRIEND&quot;);           continue; }
</span><span class="ln">248 </span><span class="comment multiline">            &quot;goto&quot;             { printf(&quot;GOTO&quot;);             continue; }
</span><span class="ln">249 </span><span class="comment multiline">            &quot;if&quot;               { printf(&quot;IF&quot;);               continue; }
</span><span class="ln">250 </span><span class="comment multiline">            &quot;inline&quot;           { printf(&quot;INLINE&quot;);           continue; }
</span><span class="ln">251 </span><span class="comment multiline">            &quot;int&quot;              { printf(&quot;INT&quot;);              continue; }
</span><span class="ln">252 </span><span class="comment multiline">            &quot;long&quot;             { printf(&quot;LONG&quot;);             continue; }
</span><span class="ln">253 </span><span class="comment multiline">            &quot;mutable&quot;          { printf(&quot;MUTABLE&quot;);          continue; }
</span><span class="ln">254 </span><span class="comment multiline">            &quot;namespace&quot;        { printf(&quot;NAMESPACE&quot;);        continue; }
</span><span class="ln">255 </span><span class="comment multiline">            &quot;operator&quot;         { printf(&quot;OPERATOR&quot;);         continue; }
</span><span class="ln">256 </span><span class="comment multiline">            &quot;private&quot;          { printf(&quot;PRIVATE&quot;);          continue; }
</span><span class="ln">257 </span><span class="comment multiline">            &quot;protected&quot;        { printf(&quot;PROTECTED&quot;);        continue; }
</span><span class="ln">258 </span><span class="comment multiline">            &quot;public&quot;           { printf(&quot;PUBLIC&quot;);           continue; }
</span><span class="ln">259 </span><span class="comment multiline">            &quot;register&quot;         { printf(&quot;REGISTER&quot;);         continue; }
</span><span class="ln">260 </span><span class="comment multiline">            &quot;reinterpret_cast&quot; { printf(&quot;REINTERPRET_CAST&quot;); continue; }
</span><span class="ln">261 </span><span class="comment multiline">            &quot;return&quot;           { printf(&quot;RETURN&quot;);           continue; }
</span><span class="ln">262 </span><span class="comment multiline">            &quot;short&quot;            { printf(&quot;SHORT&quot;);            continue; }
</span><span class="ln">263 </span><span class="comment multiline">            &quot;signed&quot;           { printf(&quot;SIGNED&quot;);           continue; }
</span><span class="ln">264 </span><span class="comment multiline">            &quot;sizeof&quot;           { printf(&quot;SIZEOF&quot;);           continue; }
</span><span class="ln">265 </span><span class="comment multiline">            &quot;static&quot;           { printf(&quot;STATIC&quot;);           continue; }
</span><span class="ln">266 </span><span class="comment multiline">            &quot;static_cast&quot;      { printf(&quot;STATIC_CAST&quot;);      continue; }
</span><span class="ln">267 </span><span class="comment multiline">            &quot;struct&quot;           { printf(&quot;STRUCT&quot;);           continue; }
</span><span class="ln">268 </span><span class="comment multiline">            &quot;switch&quot;           { printf(&quot;SWITCH&quot;);           continue; }
</span><span class="ln">269 </span><span class="comment multiline">            &quot;template&quot;         { printf(&quot;TEMPLATE&quot;);         continue; }
</span><span class="ln">270 </span><span class="comment multiline">            &quot;this&quot;             { printf(&quot;THIS&quot;);             continue; }
</span><span class="ln">271 </span><span class="comment multiline">            &quot;throw&quot;            { printf(&quot;THROW&quot;);            continue; }
</span><span class="ln">272 </span><span class="comment multiline">            &quot;try&quot;              { printf(&quot;TRY&quot;);              continue; }
</span><span class="ln">273 </span><span class="comment multiline">            &quot;typedef&quot;          { printf(&quot;TYPEDEF&quot;);          continue; }
</span><span class="ln">274 </span><span class="comment multiline">            &quot;typeid&quot;           { printf(&quot;TYPEID&quot;);           continue; }
</span><span class="ln">275 </span><span class="comment multiline">            &quot;typename&quot;         { printf(&quot;TYPENAME&quot;);         continue; }
</span><span class="ln">276 </span><span class="comment multiline">            &quot;union&quot;            { printf(&quot;UNION&quot;);            continue; }
</span><span class="ln">277 </span><span class="comment multiline">            &quot;unsigned&quot;         { printf(&quot;UNSIGNED&quot;);         continue; }
</span><span class="ln">278 </span><span class="comment multiline">            &quot;using&quot;            { printf(&quot;USING&quot;);            continue; }
</span><span class="ln">279 </span><span class="comment multiline">            &quot;virtual&quot;          { printf(&quot;VIRTUAL&quot;);          continue; }
</span><span class="ln">280 </span><span class="comment multiline">            &quot;void&quot;             { printf(&quot;VOID&quot;);             continue; }
</span><span class="ln">281 </span><span class="comment multiline">            &quot;volatile&quot;         { printf(&quot;VOLATILE&quot;);         continue; }
</span><span class="ln">282 </span><span class="comment multiline">            &quot;wchar_t&quot;          { printf(&quot;WCHAR_T&quot;);          continue; }
</span><span class="ln">283 </span><span class="comment multiline">            &quot;while&quot;            { printf(&quot;WHILE&quot;);            continue; }
</span><span class="ln">284 </span><span class="comment multiline">
</span><span class="ln">285 </span><span class="comment multiline">            // operators and punctuation (including preprocessor)
</span><span class="ln">286 </span><span class="comment multiline">            (&quot;{&quot; | &quot;&lt;%&quot;)      { printf(&quot;{&quot;);      continue; }
</span><span class="ln">287 </span><span class="comment multiline">            (&quot;}&quot; | &quot;%&gt;&quot;)      { printf(&quot;}&quot;);      continue; }
</span><span class="ln">288 </span><span class="comment multiline">            (&quot;[&quot; | &quot;&lt;:&quot;)      { printf(&quot;[&quot;);      continue; }
</span><span class="ln">289 </span><span class="comment multiline">            (&quot;]&quot; | &quot;:&gt;&quot;)      { printf(&quot;]&quot;);      continue; }
</span><span class="ln">290 </span><span class="comment multiline">            &quot;(&quot;               { printf(&quot;(&quot;);      continue; }
</span><span class="ln">291 </span><span class="comment multiline">            &quot;)&quot;               { printf(&quot;)&quot;);      continue; }
</span><span class="ln">292 </span><span class="comment multiline">            &quot;;&quot;               { printf(&quot;;&quot;);      continue; }
</span><span class="ln">293 </span><span class="comment multiline">            &quot;:&quot;               { printf(&quot;:&quot;);      continue; }
</span><span class="ln">294 </span><span class="comment multiline">            &quot;...&quot;             { printf(&quot;...&quot;);    continue; }
</span><span class="ln">295 </span><span class="comment multiline">            &quot;new&quot;             { printf(&quot;new&quot;);    continue; }
</span><span class="ln">296 </span><span class="comment multiline">            &quot;delete&quot;          { printf(&quot;delete&quot;); continue; }
</span><span class="ln">297 </span><span class="comment multiline">            &quot;?&quot;               { printf(&quot;?&quot;);      continue; }
</span><span class="ln">298 </span><span class="comment multiline">            &quot;::&quot;              { printf(&quot;::&quot;);     continue; }
</span><span class="ln">299 </span><span class="comment multiline">            &quot;.&quot;               { printf(&quot;.&quot;);      continue; }
</span><span class="ln">300 </span><span class="comment multiline">            &quot;.*&quot;              { printf(&quot;.&quot;);      continue; }
</span><span class="ln">301 </span><span class="comment multiline">            &quot;+&quot;               { printf(&quot;+&quot;);      continue; }
</span><span class="ln">302 </span><span class="comment multiline">            &quot;-&quot;               { printf(&quot;-&quot;);      continue; }
</span><span class="ln">303 </span><span class="comment multiline">            &quot;*&quot;               { printf(&quot;*&quot;);      continue; }
</span><span class="ln">304 </span><span class="comment multiline">            &quot;/&quot;               { printf(&quot;/&quot;);      continue; }
</span><span class="ln">305 </span><span class="comment multiline">            &quot;%&quot;               { printf(&quot;%%&quot;);     continue; }
</span><span class="ln">306 </span><span class="comment multiline">            (&quot;^&quot; | &quot;xor&quot;)     { printf(&quot;^&quot;);      continue; }
</span><span class="ln">307 </span><span class="comment multiline">            (&quot;&amp;&quot; | &quot;bitand&quot;)  { printf(&quot;&amp;&quot;);      continue; }
</span><span class="ln">308 </span><span class="comment multiline">            (&quot;|&quot; | &quot;bitor&quot;)   { printf(&quot;|&quot;);      continue; }
</span><span class="ln">309 </span><span class="comment multiline">            (&quot;~&quot; | &quot;compl&quot;)   { printf(&quot;~&quot;);      continue; }
</span><span class="ln">310 </span><span class="comment multiline">            (&quot;!&quot; | &quot;not&quot;)     { printf(&quot;!&quot;);      continue; }
</span><span class="ln">311 </span><span class="comment multiline">            &quot;=&quot;               { printf(&quot;=&quot;);      continue; }
</span><span class="ln">312 </span><span class="comment multiline">            &quot;&lt;&quot;               { printf(&quot;&lt;&quot;);      continue; }
</span><span class="ln">313 </span><span class="comment multiline">            &quot;&gt;&quot;               { printf(&quot;&gt;&quot;);      continue; }
</span><span class="ln">314 </span><span class="comment multiline">            &quot;+=&quot;              { printf(&quot;+=&quot;);     continue; }
</span><span class="ln">315 </span><span class="comment multiline">            &quot;-=&quot;              { printf(&quot;-=&quot;);     continue; }
</span><span class="ln">316 </span><span class="comment multiline">            &quot;*=&quot;              { printf(&quot;*=&quot;);     continue; }
</span><span class="ln">317 </span><span class="comment multiline">            &quot;/=&quot;              { printf(&quot;/=&quot;);     continue; }
</span><span class="ln">318 </span><span class="comment multiline">            &quot;%=&quot;              { printf(&quot;%%=&quot;);    continue; }
</span><span class="ln">319 </span><span class="comment multiline">            (&quot;^=&quot; | &quot;xor_eq&quot;) { printf(&quot;^=&quot;);     continue; }
</span><span class="ln">320 </span><span class="comment multiline">            (&quot;&amp;=&quot; | &quot;and_eq&quot;) { printf(&quot;&amp;=&quot;);     continue; }
</span><span class="ln">321 </span><span class="comment multiline">            (&quot;|=&quot; | &quot;or_eq&quot;)  { printf(&quot;|=&quot;);     continue; }
</span><span class="ln">322 </span><span class="comment multiline">            &quot;&lt;&lt;&quot;              { printf(&quot;&lt;&lt;&quot;);     continue; }
</span><span class="ln">323 </span><span class="comment multiline">            &quot;&gt;&gt;&quot;              { printf(&quot;&gt;&gt;&quot;);     continue; }
</span><span class="ln">324 </span><span class="comment multiline">            &quot;&gt;&gt;=&quot;             { printf(&quot;&gt;&gt;=&quot;);    continue; }
</span><span class="ln">325 </span><span class="comment multiline">            &quot;&lt;&lt;=&quot;             { printf(&quot;&lt;&lt;=&quot;);    continue; }
</span><span class="ln">326 </span><span class="comment multiline">            &quot;==&quot;              { printf(&quot;==&quot;);     continue; }
</span><span class="ln">327 </span><span class="comment multiline">            (&quot;!=&quot; | &quot;not_eq&quot;) { printf(&quot;!=&quot;);     continue; }
</span><span class="ln">328 </span><span class="comment multiline">            &quot;&lt;=&quot;              { printf(&quot;&lt;=&quot;);     continue; }
</span><span class="ln">329 </span><span class="comment multiline">            &quot;&gt;=&quot;              { printf(&quot;&gt;=&quot;);     continue; }
</span><span class="ln">330 </span><span class="comment multiline">            (&quot;&amp;&amp;&quot; | &quot;and&quot;)    { printf(&quot;&amp;&amp;&quot;);     continue; }
</span><span class="ln">331 </span><span class="comment multiline">            (&quot;||&quot; | &quot;or&quot;)     { printf(&quot;||&quot;);     continue; }
</span><span class="ln">332 </span><span class="comment multiline">            &quot;++&quot;              { printf(&quot;++&quot;);     continue; }
</span><span class="ln">333 </span><span class="comment multiline">            &quot;--&quot;              { printf(&quot;--&quot;);     continue; }
</span><span class="ln">334 </span><span class="comment multiline">            &quot;,&quot;               { printf(&quot;,&quot;);      continue; }
</span><span class="ln">335 </span><span class="comment multiline">            &quot;-&gt;*&quot;             { printf(&quot;-&gt;*&quot;);    continue; }
</span><span class="ln">336 </span><span class="comment multiline">            &quot;-&gt;&quot;              { printf(&quot;-&gt;&quot;);     continue; }
</span><span class="ln">337 </span><span class="comment multiline">
</span><span class="ln">338 </span><span class="comment multiline">            // identifiers
</span><span class="ln">339 </span><span class="comment multiline">            id = [a-zA-Z_][a-zA-Z_0-9]*;
</span><span class="ln">340 </span><span class="comment multiline">            id { printf(&quot;%.*s&quot;, in.cur - in.tok, in.tok); continue; }
</span><span class="ln">341 </span><span class="comment multiline">        */</span>
<span class="ln">342 </span><span class="name label">sfx</span><span class="punctuation">:</span>
<span class="ln">343 </span>        <span class="comment multiline">/*!re2c
</span><span class="ln">344 </span><span class="comment multiline">            &quot;&quot;          { if (u &gt; INT_MAX)  return false; printf(&quot;%d&quot;,  static_cast&lt;int&gt;(u));      continue; }
</span><span class="ln">345 </span><span class="comment multiline">            'u'         { if (u &gt; UINT_MAX) return false; printf(&quot;%u&quot;,  static_cast&lt;unsigned&gt;(u)); continue; }
</span><span class="ln">346 </span><span class="comment multiline">            'l'         { if (u &gt; LONG_MAX) return false; printf(&quot;%ld&quot;, static_cast&lt;long&gt;(u));     continue; }
</span><span class="ln">347 </span><span class="comment multiline">            'ul' | 'lu' { printf(&quot;%lu&quot;, u); continue; }
</span><span class="ln">348 </span><span class="comment multiline">        */</span>
<span class="ln">349 </span>    <span class="punctuation">}</span>
<span class="ln">350 </span><span class="punctuation">}</span>
<span class="ln">351 </span>
<span class="ln">352 </span><span class="keyword type">int</span> <span class="name">main</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">argc</span><span class="punctuation">,</span> <span class="keyword type">char</span> <span class="operator">**</span><span class="name">argv</span><span class="punctuation">)</span>
<span class="ln">353 </span><span class="punctuation">{</span>
<span class="ln">354 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">argc</span> <span class="operator">!=</span> <span class="literal number integer">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">355 </span>        <span class="name">printf</span> <span class="punctuation">(</span><span class="literal string">&quot;usage: ./example &lt;filename&gt;</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">);</span>
<span class="ln">356 </span>        <span class="keyword">return</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">357 </span>    <span class="punctuation">}</span>
<span class="ln">358 </span>
<span class="ln">359 </span>    <span class="keyword type">FILE</span> <span class="operator">*</span><span class="name">file</span> <span class="operator">=</span> <span class="name">fopen</span><span class="punctuation">(</span><span class="name">argv</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="literal string">&quot;rb&quot;</span><span class="punctuation">);</span>
<span class="ln">360 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">file</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">361 </span>        <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;error: cannot open file: %s</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">,</span> <span class="name">argv</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]);</span>
<span class="ln">362 </span>        <span class="keyword">return</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">363 </span>    <span class="punctuation">}</span>
<span class="ln">364 </span>
<span class="ln">365 </span>    <span class="keyword type">input_t</span> <span class="name">in</span><span class="punctuation">(</span><span class="name">file</span><span class="punctuation">);</span>
<span class="ln">366 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">lex</span><span class="punctuation">(</span><span class="name">in</span><span class="punctuation">))</span> <span class="punctuation">{</span>
<span class="ln">367 </span>        <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;... error</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">);</span>
<span class="ln">368 </span>    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
<span class="ln">369 </span>        <span class="name">printf</span><span class="punctuation">(</span><span class="literal string">&quot;</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">);</span>
<span class="ln">370 </span>    <span class="punctuation">}</span>
<span class="ln">371 </span>
<span class="ln">372 </span>    <span class="name">fclose</span><span class="punctuation">(</span><span class="name">file</span><span class="punctuation">);</span>
<span class="ln">373 </span>    <span class="keyword">return</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">374 </span><span class="punctuation">}</span>
</pre>
<p>Notes:</p>
<ul class="simple">
<li>The main lexer is used to lex all trivial lexemes (macros, whitespaces, boolean literals, keywords, operators and punctuators, identifiers),
recognize numeric literals (which are further parsed by a bunch of auxilary lexers),
and recognize the start of string and character literals (which are further recognized and parsed by an auxilary lexer).
Numeric literals are thus lexed twice: this approach may be deemed inefficient,
but it takes much more effort to validate and parse them at once.
Besides, a real-world lexer would rather recognize ill-formed lexemes (e.g. overflowed integer literals),
report them and resume lexing.</li>
<li>We don't use re2c in cases when hand-written parser looks simpler: when parsing octal and decimal literals
(though re2c-based parser would do exactly the same, without the slightest overhead).
However, hexadecimal literals still require some lexing, which looks better with re2c.
Again, it's only a matter of taste: re2c-based implementation adds no overhead.
Look at the generated code to make sure.</li>
<li>The main lexer and string lexer both use <tt class="docutils literal">re2c:yyfill:enable = 1;</tt>, other lexers use <tt class="docutils literal">re2c:yyfill:enable = 0;</tt>.
This is very important: both main lexer and string lexer advance input position to new (yet unseen) input characters,
so they must check for the end of input and call <tt class="docutils literal">YYFILL</tt>. In conrast, other lexers only parse lexemes that
have been already recognized by the main lexer: these lexemes are guaranteed to be within buffer bounds
(they are guarded by <tt class="docutils literal">in.tok</tt> on the left and <tt class="docutils literal">in.lim</tt> on the right).</li>
<li>The hardest part is (unsurprisingly) floating-point literals.
They are just as hard to lex as to use. <tt class="docutils literal">:)</tt></li>
</ul>
<p>Generate, compile and run:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -o example.cc 07_cxx98.re
<span class="name variable">$ </span>g++ -o example example.cc
<span class="name variable">$ </span>./example 07_cxx98.re <span class="punctuation">|</span> fold
 STATIC CONST size_t <span class="name variable">SIZE</span> <span class="operator">=</span> <span class="literal number">64</span> * 1024<span class="punctuation">;</span> STRUCT input_t <span class="operator">{</span> UNSIGNED CHAR buf<span class="operator">[</span>SIZE +
 YYMAXFILL<span class="operator">]</span><span class="punctuation">;</span> UNSIGNED CHAR *lim<span class="punctuation">;</span> UNSIGNED CHAR *cur<span class="punctuation">;</span> UNSIGNED CHAR *mar<span class="punctuation">;</span> UNSIGNE
D CHAR *tok<span class="punctuation">;</span> BOOL eof<span class="punctuation">;</span> FILE *CONST file<span class="punctuation">;</span> input_t<span class="operator">(</span>FILE *f<span class="operator">)</span> : buf<span class="operator">()</span> , lim<span class="operator">(</span>buf + SI
ZE<span class="operator">)</span> , cur<span class="operator">(</span>lim<span class="operator">)</span> , mar<span class="operator">(</span>lim<span class="operator">)</span> , tok<span class="operator">(</span>lim<span class="operator">)</span> , eof<span class="operator">(</span><span class="name builtin">false</span><span class="operator">)</span> , file<span class="operator">(</span>f<span class="operator">)</span> <span class="operator">{}</span> BOOL fill<span class="operator">(</span>size_t
need<span class="operator">)</span> <span class="operator">{</span> IF <span class="operator">(</span>eof<span class="operator">)</span> <span class="operator">{</span> RETURN <span class="name builtin">false</span><span class="punctuation">;</span> <span class="operator">}</span> CONST size_t <span class="name variable">free</span> <span class="operator">=</span> tok - buf<span class="punctuation">;</span> IF <span class="operator">(</span>free &lt; nee
d<span class="operator">)</span> <span class="operator">{</span> RETURN <span class="name builtin">false</span><span class="punctuation">;</span> <span class="operator">}</span> memmove<span class="operator">(</span>buf, tok, lim - tok<span class="operator">)</span><span class="punctuation">;</span> lim -<span class="operator">=</span> free<span class="punctuation">;</span> cur -<span class="operator">=</span> free<span class="punctuation">;</span> mar
 -<span class="operator">=</span> free<span class="punctuation">;</span> tok -<span class="operator">=</span> free<span class="punctuation">;</span> lim +<span class="operator">=</span> fread<span class="operator">(</span>lim, 1, free, file<span class="operator">)</span><span class="punctuation">;</span> IF <span class="operator">(</span>lim &lt; buf + SIZE<span class="operator">)</span> <span class="operator">{</span>
 <span class="name variable">eof</span> <span class="operator">=</span> <span class="name builtin">true</span><span class="punctuation">;</span> memset<span class="operator">(</span>lim, 0, YYMAXFILL<span class="operator">)</span><span class="punctuation">;</span> lim +<span class="operator">=</span> YYMAXFILL<span class="punctuation">;</span> <span class="operator">}</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> <span class="operator">}</span><span class="punctuation">;</span> TE
MPLATE&lt;INT base&gt; STATIC BOOL adddgt<span class="operator">(</span>UNSIGNED LONG <span class="punctuation">&amp;</span>u, UNSIGNED LONG d<span class="operator">)</span> <span class="operator">{</span> IF <span class="operator">(</span>u &gt;
 <span class="operator">(</span>ULONG_MAX - d<span class="operator">)</span> / base<span class="operator">)</span> <span class="operator">{</span> RETURN <span class="name builtin">false</span><span class="punctuation">;</span> <span class="operator">}</span> <span class="name variable">u</span> <span class="operator">=</span> u * base + d<span class="punctuation">;</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STAT
IC BOOL lex_oct<span class="operator">(</span>CONST UNSIGNED CHAR *s, CONST UNSIGNED CHAR *e, UNSIGNED LONG <span class="punctuation">&amp;</span>u
<span class="operator">)</span> <span class="operator">{</span> FOR <span class="operator">(</span><span class="name variable">u</span> <span class="operator">=</span> 0, ++s<span class="punctuation">;</span> s &lt; e<span class="punctuation">;</span> ++s<span class="operator">)</span> <span class="operator">{</span> IF <span class="operator">(</span>!adddgt&lt;8&gt;<span class="operator">(</span>u, *s - 48<span class="operator">))</span> <span class="operator">{</span> RETURN <span class="name builtin">false</span><span class="punctuation">;</span> <span class="operator">}</span>
 <span class="operator">}</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STATIC BOOL lex_dec<span class="operator">(</span>CONST UNSIGNED CHAR *s, CONST UNSIGNED CHA
R *e, UNSIGNED LONG <span class="punctuation">&amp;</span>u<span class="operator">)</span> <span class="operator">{</span> FOR <span class="operator">(</span><span class="name variable">u</span> <span class="operator">=</span> 0<span class="punctuation">;</span> s &lt; e<span class="punctuation">;</span> ++s<span class="operator">)</span> <span class="operator">{</span> IF <span class="operator">(</span>!adddgt&lt;10&gt;<span class="operator">(</span>u, *s - 48<span class="operator">))</span>
 <span class="operator">{</span> RETURN <span class="name builtin">false</span><span class="punctuation">;</span> <span class="operator">}</span> <span class="operator">}</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STATIC BOOL lex_hex<span class="operator">(</span>CONST UNSIGNED CHAR *s,
CONST UNSIGNED CHAR *e, UNSIGNED LONG <span class="punctuation">&amp;</span>u<span class="operator">)</span> <span class="operator">{</span> FOR <span class="operator">(</span><span class="name variable">u</span> <span class="operator">=</span> 0, s +<span class="operator">=</span> 2<span class="punctuation">;</span> s &lt; e<span class="punctuation">;</span><span class="operator">)</span> <span class="operator">{</span> <span class="operator">}</span> RETU
RN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STATIC BOOL lex_str<span class="operator">(</span>input_t <span class="punctuation">&amp;</span>in, UNSIGNED CHAR q<span class="operator">)</span> <span class="operator">{</span> <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x25\x63&quot;</span>
, q<span class="operator">)</span><span class="punctuation">;</span> FOR <span class="operator">(</span>UNSIGNED LONG <span class="name variable">u</span> <span class="operator">=</span> q<span class="punctuation">;;</span> <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x5c\x78\x25\x6c\x78&quot;</span>, u<span class="operator">))</span> <span class="operator">{</span> in.tok <span class="operator">=</span> i
n.cur<span class="punctuation">;</span> <span class="operator">}</span> <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x25\x63&quot;</span>, q<span class="operator">)</span><span class="punctuation">;</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STATIC BOOL lex_flt<span class="operator">(</span>CONST UNSIGNE
D CHAR *s<span class="operator">)</span> <span class="operator">{</span> DOUBLE <span class="name variable">d</span> <span class="operator">=</span> 0<span class="punctuation">;</span> DOUBLE <span class="name variable">x</span> <span class="operator">=</span> 1<span class="punctuation">;</span> INT <span class="name variable">e</span> <span class="operator">=</span> 0<span class="punctuation">;</span> mant_int: mant_frac: exp_sig
n: exp: sfx: end: <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x25\x67&quot;</span>, d<span class="operator">)</span><span class="punctuation">;</span> RETURN <span class="name builtin">true</span><span class="punctuation">;</span> <span class="operator">}</span> STATIC BOOL lex<span class="operator">(</span>input_t
<span class="punctuation">&amp;</span>in<span class="operator">)</span> <span class="operator">{</span> UNSIGNED LONG u<span class="punctuation">;</span> FOR <span class="operator">(</span><span class="punctuation">;;</span><span class="operator">)</span> <span class="operator">{</span> in.tok <span class="operator">=</span> in.cur<span class="punctuation">;</span> sfx: <span class="operator">}</span> <span class="operator">}</span> INT main<span class="operator">(</span>INT argc,
CHAR **argv<span class="operator">)</span> <span class="operator">{</span> IF <span class="operator">(</span>argc !<span class="operator">=</span> 2<span class="operator">)</span> <span class="operator">{</span> <span class="name builtin">printf</span> <span class="operator">(</span><span class="literal string double">&quot;\x75\x73\x61\x67\x65\x3a\x20\x2e\x2f\x6
5\x78\x61\x6d\x70\x6c\x65\x20\x3c\x66\x69\x6c\x65\x6e\x61\x6d\x65\x3e\xa&quot;</span><span class="operator">)</span><span class="punctuation">;</span> RETU
RN 1<span class="punctuation">;</span> <span class="operator">}</span> FILE *file <span class="operator">=</span> fopen<span class="operator">(</span>argv<span class="operator">[</span>1<span class="operator">]</span>, <span class="literal string double">&quot;\x72\x62&quot;</span><span class="operator">)</span><span class="punctuation">;</span> IF <span class="operator">(</span>!file<span class="operator">)</span> <span class="operator">{</span> <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x65\x72\x
72\x6f\x72\x3a\x20\x63\x61\x6e\x6e\x6f\x74\x20\x6f\x70\x65\x6e\x20\x66\x69\x6c\x
65\x3a\x20\x25\x73\xa&quot;</span>, argv<span class="operator">[</span>1<span class="operator">])</span><span class="punctuation">;</span> RETURN 1<span class="punctuation">;</span> <span class="operator">}</span> input_t in<span class="operator">(</span>file<span class="operator">)</span><span class="punctuation">;</span> IF <span class="operator">(</span>!lex<span class="operator">(</span>in<span class="operator">))</span> <span class="operator">{</span>
<span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\x2e\x2e\x2e\x20\x65\x72\x72\x6f\x72\xa&quot;</span><span class="operator">)</span><span class="punctuation">;</span> <span class="operator">}</span> ELSE <span class="operator">{</span> <span class="name builtin">printf</span><span class="operator">(</span><span class="literal string double">&quot;\xa&quot;</span><span class="operator">)</span><span class="punctuation">;</span> <span class="operator">}</span> fcl
ose<span class="operator">(</span>file<span class="operator">)</span><span class="punctuation">;</span> RETURN 0<span class="punctuation">;</span> <span class="operator">}</span>
</pre>
</div>
<div class="footer">
<hr class="footer" />
<a class="reference external" href="../index.html">[home]</a> <a class="reference external" href="examples.html">[Examples]</a>
</div>
</body>
</html>
