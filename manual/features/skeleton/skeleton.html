<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Skeleton</title>
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="alternate" type="application/atom+xml" href="/feed/atom.xml" title="Atom 1.0" />
<link rel="icon" href="/favicon.ico" />
</head>
<body>
<div class="header">
<a class="reference external" href="../../../index.html">[home]</a> <a class="reference external" href="../../manual.html">[Manual]</a> <a class="reference external" href="../features.html">[Features]</a>
<hr class="header"/>
</div>
<div class="document" id="skeleton">
<h1 class="title">Skeleton</h1>

<div class="contents topic" id="id3">
<p class="topic-title first">â˜…</p>
<ul class="simple">
<li><a class="reference internal" href="#example" id="id4">Example</a></li>
<li><a class="reference internal" href="#failures" id="id5">Failures</a><ul>
<li><a class="reference internal" href="#artificial-examples" id="id6">Artificial examples</a></li>
<li><a class="reference internal" href="#undefined-control-flow" id="id7">Undefined control flow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generating-data" id="id8">Generating data</a></li>
<li><a class="reference internal" href="#use" id="id9">Use</a><ul>
<li><a class="reference internal" href="#code-verification" id="id10">Code verification</a></li>
<li><a class="reference internal" href="#benchmarks" id="id11">Benchmarks</a></li>
<li><a class="reference internal" href="#executable-specs" id="id12">Executable specs</a></li>
</ul>
</li>
</ul>
</div>
<p>With <tt class="docutils literal"><span class="pre">-S,</span> <span class="pre">--skeleton</span></tt> option re2c ignores all non-re2c code and generates a self-contained C-90 program
that can be further compiled and executed.
The program consists of lexer code and input data.
For each constructed DFA (block or condition) re2c generates a standalone lexer and two files:
<tt class="docutils literal">.input</tt> file with strings derived from the DFA and <tt class="docutils literal">.keys</tt> file with expected match results.
The program runs each lexer on the corresponding <tt class="docutils literal">.input</tt> file
and compares results with the expectations.</p>
<div class="section" id="example">
<h1>Example</h1>
<p><a class="reference external" href="hex2.re">[hex2.re]</a></p>
<pre class="code c literal-block">
<span class="ln">1 </span><span class="comment multiline">/*!re2c
</span><span class="ln">2 </span><span class="comment multiline">    *              {}
</span><span class="ln">3 </span><span class="comment multiline">    [0-9a-fA-F]{2} {}
</span><span class="ln">4 </span><span class="comment multiline">*/</span>
</pre>
<p>Here is a very simple program (it tries to match two-digit hexadecimal numbers).
We can see the generated DFA using <tt class="docutils literal">`re2c <span class="pre">-D</span> hex2.re | dot <span class="pre">-Gratio=0.5</span> <span class="pre">-Tpng</span> <span class="pre">-o</span> example.png`</tt>:</p>
<img alt="example.png" src="example.png" style="width: 40%;" />
<p>Given this program, <tt class="docutils literal">`re2c <span class="pre">-S</span> <span class="pre">-o</span> example.c hex2.re`</tt> generates three files:
<tt class="docutils literal">example.c</tt> (main program), <tt class="docutils literal">example.c.line4.input</tt> (input data) and <tt class="docutils literal">example.c.line4.keys</tt> (expected match results).
First, let's look at the generated strings:</p>
<p><a class="reference external" href="example.c.line4.input">[example.c.line4.input]</a></p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>hexdump -C example.c.line4.input
<span class="literal number">00000000</span>  <span class="literal number">00</span> 2f 3a <span class="literal number">40</span> <span class="literal number">47</span> <span class="literal number">60</span> <span class="literal number">67</span> ff  <span class="literal number">30</span> <span class="literal number">30</span> <span class="literal number">30</span> <span class="literal number">39</span> <span class="literal number">30</span> <span class="literal number">41</span> <span class="literal number">30</span> <span class="literal number">46</span>  <span class="punctuation">|</span>./:&#64;G<span class="literal string backtick">`</span>g.00090A0F<span class="punctuation">|</span>
<span class="literal number">00000010</span>  <span class="literal number">30</span> <span class="literal number">61</span> <span class="literal number">30</span> <span class="literal number">66</span> <span class="literal number">39</span> <span class="literal number">30</span> <span class="literal number">39</span> <span class="literal number">39</span>  <span class="literal number">39</span> <span class="literal number">41</span> <span class="literal number">39</span> <span class="literal number">46</span> <span class="literal number">39</span> <span class="literal number">61</span> <span class="literal number">39</span> <span class="literal number">66</span>  <span class="punctuation">|</span>0a0f90999A9F9a9f<span class="punctuation">|</span>
<span class="literal number">00000020</span>  <span class="literal number">41</span> <span class="literal number">30</span> <span class="literal number">41</span> <span class="literal number">39</span> <span class="literal number">41</span> <span class="literal number">41</span> <span class="literal number">41</span> <span class="literal number">46</span>  <span class="literal number">41</span> <span class="literal number">61</span> <span class="literal number">41</span> <span class="literal number">66</span> <span class="literal number">46</span> <span class="literal number">30</span> <span class="literal number">46</span> <span class="literal number">39</span>  <span class="punctuation">|</span>A0A9AAAFAaAfF0F9<span class="punctuation">|</span>
<span class="literal number">00000030</span>  <span class="literal number">46</span> <span class="literal number">41</span> <span class="literal number">46</span> <span class="literal number">46</span> <span class="literal number">46</span> <span class="literal number">61</span> <span class="literal number">46</span> <span class="literal number">66</span>  <span class="literal number">61</span> <span class="literal number">30</span> <span class="literal number">61</span> <span class="literal number">39</span> <span class="literal number">61</span> <span class="literal number">41</span> <span class="literal number">61</span> <span class="literal number">46</span>  <span class="punctuation">|</span>FAFFFaFfa0a9aAaF<span class="punctuation">|</span>
<span class="literal number">00000040</span>  <span class="literal number">61</span> <span class="literal number">61</span> <span class="literal number">61</span> <span class="literal number">66</span> <span class="literal number">66</span> <span class="literal number">30</span> <span class="literal number">66</span> <span class="literal number">39</span>  <span class="literal number">66</span> <span class="literal number">41</span> <span class="literal number">66</span> <span class="literal number">46</span> <span class="literal number">66</span> <span class="literal number">61</span> <span class="literal number">66</span> <span class="literal number">66</span>  <span class="punctuation">|</span>aaaff0f9fAfFfaff<span class="punctuation">|</span>
<span class="literal number">00000050</span>  <span class="literal number">30</span> <span class="literal number">00</span> <span class="literal number">30</span> 2f <span class="literal number">30</span> 3a <span class="literal number">30</span> <span class="literal number">40</span>  <span class="literal number">30</span> <span class="literal number">47</span> <span class="literal number">30</span> <span class="literal number">60</span> <span class="literal number">30</span> <span class="literal number">67</span> <span class="literal number">30</span> ff  <span class="punctuation">|</span>0.0/0:0&#64;0G0<span class="literal string backtick">`</span>0g0.<span class="punctuation">|</span>
<span class="literal number">00000060</span>  <span class="literal number">39</span> <span class="literal number">00</span> <span class="literal number">39</span> 2f <span class="literal number">39</span> 3a <span class="literal number">39</span> <span class="literal number">40</span>  <span class="literal number">39</span> <span class="literal number">47</span> <span class="literal number">39</span> <span class="literal number">60</span> <span class="literal number">39</span> <span class="literal number">67</span> <span class="literal number">39</span> ff  <span class="punctuation">|</span>9.9/9:9&#64;9G9<span class="literal string backtick">`</span>9g9.<span class="punctuation">|</span>
<span class="literal number">00000070</span>  <span class="literal number">41</span> <span class="literal number">00</span> <span class="literal number">41</span> 2f <span class="literal number">41</span> 3a <span class="literal number">41</span> <span class="literal number">40</span>  <span class="literal number">41</span> <span class="literal number">47</span> <span class="literal number">41</span> <span class="literal number">60</span> <span class="literal number">41</span> <span class="literal number">67</span> <span class="literal number">41</span> ff  <span class="punctuation">|</span>A.A/A:A&#64;AGA<span class="literal string backtick">`</span>AgA.<span class="punctuation">|</span>
<span class="literal number">00000080</span>  <span class="literal number">46</span> <span class="literal number">00</span> <span class="literal number">46</span> 2f <span class="literal number">46</span> 3a <span class="literal number">46</span> <span class="literal number">40</span>  <span class="literal number">46</span> <span class="literal number">47</span> <span class="literal number">46</span> <span class="literal number">60</span> <span class="literal number">46</span> <span class="literal number">67</span> <span class="literal number">46</span> ff  <span class="punctuation">|</span>F.F/F:F&#64;FGF<span class="literal string backtick">`</span>FgF.<span class="punctuation">|</span>
<span class="literal number">00000090</span>  <span class="literal number">61</span> <span class="literal number">00</span> <span class="literal number">61</span> 2f <span class="literal number">61</span> 3a <span class="literal number">61</span> <span class="literal number">40</span>  <span class="literal number">61</span> <span class="literal number">47</span> <span class="literal number">61</span> <span class="literal number">60</span> <span class="literal number">61</span> <span class="literal number">67</span> <span class="literal number">61</span> ff  <span class="punctuation">|</span>a.a/a:a&#64;aGa<span class="literal string backtick">`</span>aga.<span class="punctuation">|</span>
000000a0  <span class="literal number">66</span> <span class="literal number">00</span> <span class="literal number">66</span> 2f <span class="literal number">66</span> 3a <span class="literal number">66</span> <span class="literal number">40</span>  <span class="literal number">66</span> <span class="literal number">47</span> <span class="literal number">66</span> <span class="literal number">60</span> <span class="literal number">66</span> <span class="literal number">67</span> <span class="literal number">66</span> ff  <span class="punctuation">|</span>f.f/f:f&#64;fGf<span class="literal string backtick">`</span>fgf.<span class="punctuation">|</span>
000000b0
</pre>
<p>Byte sequences correspond to the paths in DFA.
All strings are glued together, so it's hard to tell where is the end of one string and the beginning of another.
For that re2c generates keys:</p>
<p><a class="reference external" href="example.c.line4.keys">[example.c.line4.keys]</a></p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>hexdump -v -e <span class="literal string single">'&quot;%04_ax| &quot; 24/1 &quot;%02x &quot; &quot;\n&quot;'</span> example.c.line4.keys
0000<span class="punctuation">|</span> <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe <span class="literal number">01</span> <span class="literal number">01</span> fe
0018<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> 00
0030<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> 00
0048<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> 00
0060<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> 00
0078<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">02</span> <span class="literal number">00</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
0090<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
00a8<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
00c0<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
00d8<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
00f0<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
0108<span class="punctuation">|</span> <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe <span class="literal number">02</span> <span class="literal number">01</span> fe
</pre>
<p>A key is a triplet: string length, the length of matching prefix and the number of matching rule.
All three components occupy equal amount of memory (re2c uses unsigned integer type of minimal sufficient width).
Keys are packed into array of length <tt class="docutils literal">3 * n</tt> (where <tt class="docutils literal">n</tt> is the number of keys).
In our case each triplet occupies three bytes.</p>
<p>And finally, the program itself:</p>
<p><a class="reference external" href="example.c">[example.c]</a></p>
<pre class="code c literal-block">
<span class="ln">  1 </span><span class="comment multiline">/* Generated by re2c 0.14.1.dev on Mon Nov 16 15:03:12 2015*/</span>
<span class="ln">  2 </span>
<span class="ln">  3 </span><span class="comment preproc">#include &lt;stdio.h&gt;
</span><span class="ln">  4 </span><span class="comment preproc">#include &lt;stdlib.h&gt; </span><span class="comment multiline">/* malloc, free */</span><span class="comment preproc">
</span><span class="ln">  5 </span><span class="comment preproc"></span>
<span class="ln">  6 </span><span class="keyword">static</span> <span class="keyword type">void</span> <span class="operator">*</span><span class="name function">read_file</span>
<span class="ln">  7 </span>    <span class="punctuation">(</span> <span class="keyword">const</span> <span class="keyword type">char</span> <span class="operator">*</span><span class="name">fname</span>
<span class="ln">  8 </span>    <span class="punctuation">,</span> <span class="keyword type">size_t</span> <span class="name">unit</span>
<span class="ln">  9 </span>    <span class="punctuation">,</span> <span class="keyword type">size_t</span> <span class="name">padding</span>
<span class="ln"> 10 </span>    <span class="punctuation">,</span> <span class="keyword type">size_t</span> <span class="operator">*</span><span class="name">pfsize</span>
<span class="ln"> 11 </span>    <span class="punctuation">)</span>
<span class="ln"> 12 </span><span class="punctuation">{</span>
<span class="ln"> 13 </span>    <span class="keyword type">void</span> <span class="operator">*</span><span class="name">buffer</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln"> 14 </span>    <span class="keyword type">size_t</span> <span class="name">fsize</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln"> 15 </span>
<span class="ln"> 16 </span>    <span class="comment multiline">/* open file */</span>
<span class="ln"> 17 </span>    <span class="keyword type">FILE</span> <span class="operator">*</span><span class="name">f</span> <span class="operator">=</span> <span class="name">fopen</span><span class="punctuation">(</span><span class="name">fname</span><span class="punctuation">,</span> <span class="literal string">&quot;rb&quot;</span><span class="punctuation">);</span>
<span class="ln"> 18 </span>    <span class="keyword">if</span><span class="punctuation">(</span><span class="name">f</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 19 </span>        <span class="keyword">goto</span> <span class="name">error</span><span class="punctuation">;</span>
<span class="ln"> 20 </span>    <span class="punctuation">}</span>
<span class="ln"> 21 </span>
<span class="ln"> 22 </span>    <span class="comment multiline">/* get file size */</span>
<span class="ln"> 23 </span>    <span class="name">fseek</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name">SEEK_END</span><span class="punctuation">);</span>
<span class="ln"> 24 </span>    <span class="name">fsize</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">size_t</span><span class="punctuation">)</span> <span class="name">ftell</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="name">unit</span><span class="punctuation">;</span>
<span class="ln"> 25 </span>    <span class="name">fseek</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name">SEEK_SET</span><span class="punctuation">);</span>
<span class="ln"> 26 </span>
<span class="ln"> 27 </span>    <span class="comment multiline">/* allocate memory for file and padding */</span>
<span class="ln"> 28 </span>    <span class="name">buffer</span> <span class="operator">=</span> <span class="name">malloc</span><span class="punctuation">(</span><span class="name">unit</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">fsize</span> <span class="operator">+</span> <span class="name">padding</span><span class="punctuation">));</span>
<span class="ln"> 29 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">buffer</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 30 </span>        <span class="keyword">goto</span> <span class="name">error</span><span class="punctuation">;</span>
<span class="ln"> 31 </span>    <span class="punctuation">}</span>
<span class="ln"> 32 </span>
<span class="ln"> 33 </span>    <span class="comment multiline">/* read the whole file in memory */</span>
<span class="ln"> 34 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">fread</span><span class="punctuation">(</span><span class="name">buffer</span><span class="punctuation">,</span> <span class="name">unit</span><span class="punctuation">,</span> <span class="name">fsize</span><span class="punctuation">,</span> <span class="name">f</span><span class="punctuation">)</span> <span class="operator">!=</span> <span class="name">fsize</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 35 </span>        <span class="keyword">goto</span> <span class="name">error</span><span class="punctuation">;</span>
<span class="ln"> 36 </span>    <span class="punctuation">}</span>
<span class="ln"> 37 </span>
<span class="ln"> 38 </span>    <span class="name">fclose</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">);</span>
<span class="ln"> 39 </span>    <span class="operator">*</span><span class="name">pfsize</span> <span class="operator">=</span> <span class="name">fsize</span><span class="punctuation">;</span>
<span class="ln"> 40 </span>    <span class="keyword">return</span> <span class="name">buffer</span><span class="punctuation">;</span>
<span class="ln"> 41 </span>
<span class="ln"> 42 </span><span class="name label">error</span><span class="punctuation">:</span>
<span class="ln"> 43 </span>    <span class="name">fprintf</span><span class="punctuation">(</span><span class="name">stderr</span><span class="punctuation">,</span> <span class="literal string">&quot;error: cannot read file '%s'</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">,</span> <span class="name">fname</span><span class="punctuation">);</span>
<span class="ln"> 44 </span>    <span class="name">free</span><span class="punctuation">(</span><span class="name">buffer</span><span class="punctuation">);</span>
<span class="ln"> 45 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">f</span> <span class="operator">!=</span> <span class="name builtin">NULL</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 46 </span>        <span class="name">fclose</span><span class="punctuation">(</span><span class="name">f</span><span class="punctuation">);</span>
<span class="ln"> 47 </span>    <span class="punctuation">}</span>
<span class="ln"> 48 </span>    <span class="keyword">return</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln"> 49 </span><span class="punctuation">}</span>
<span class="ln"> 50 </span>
<span class="ln"> 51 </span><span class="comment preproc">#define YYCTYPE unsigned char
</span><span class="ln"> 52 </span><span class="comment preproc">#define YYKEYTYPE unsigned char
</span><span class="ln"> 53 </span><span class="comment preproc">#define YYPEEK() *cursor
</span><span class="ln"> 54 </span><span class="comment preproc">#define YYSKIP() ++cursor
</span><span class="ln"> 55 </span><span class="comment preproc">#define YYLESSTHAN(n) (limit - cursor) &lt; n
</span><span class="ln"> 56 </span><span class="comment preproc">#define YYFILL(n) { break; }
</span><span class="ln"> 57 </span><span class="comment preproc"></span>
<span class="ln"> 58 </span><span class="keyword">static</span> <span class="keyword type">int</span> <span class="name function">action_line4</span>
<span class="ln"> 59 </span>    <span class="punctuation">(</span> <span class="keyword type">unsigned</span> <span class="keyword type">int</span> <span class="name">i</span>
<span class="ln"> 60 </span>    <span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">YYKEYTYPE</span> <span class="operator">*</span><span class="name">keys</span>
<span class="ln"> 61 </span>    <span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">start</span>
<span class="ln"> 62 </span>    <span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">token</span>
<span class="ln"> 63 </span>    <span class="punctuation">,</span> <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">**</span><span class="name">cursor</span>
<span class="ln"> 64 </span>    <span class="punctuation">,</span> <span class="name">YYKEYTYPE</span> <span class="name">rule_act</span>
<span class="ln"> 65 </span>    <span class="punctuation">)</span>
<span class="ln"> 66 </span><span class="punctuation">{</span>
<span class="ln"> 67 </span>    <span class="keyword">const</span> <span class="keyword type">long</span> <span class="name">pos</span> <span class="operator">=</span> <span class="name">token</span> <span class="operator">-</span> <span class="name">start</span><span class="punctuation">;</span>
<span class="ln"> 68 </span>    <span class="keyword">const</span> <span class="keyword type">long</span> <span class="name">len_act</span> <span class="operator">=</span> <span class="operator">*</span><span class="name">cursor</span> <span class="operator">-</span> <span class="name">token</span><span class="punctuation">;</span>
<span class="ln"> 69 </span>    <span class="keyword">const</span> <span class="keyword type">long</span> <span class="name">len_exp</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">long</span><span class="punctuation">)</span> <span class="name">keys</span> <span class="punctuation">[</span><span class="literal number integer">3</span> <span class="operator">*</span> <span class="name">i</span> <span class="operator">+</span> <span class="literal number integer">1</span><span class="punctuation">];</span>
<span class="ln"> 70 </span>    <span class="keyword">const</span> <span class="name">YYKEYTYPE</span> <span class="name">rule_exp</span> <span class="operator">=</span> <span class="name">keys</span> <span class="punctuation">[</span><span class="literal number integer">3</span> <span class="operator">*</span> <span class="name">i</span> <span class="operator">+</span> <span class="literal number integer">2</span><span class="punctuation">];</span>
<span class="ln"> 71 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">rule_exp</span> <span class="operator">==</span> <span class="literal number integer">255</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 72 </span>        <span class="name">fprintf</span>
<span class="ln"> 73 </span>            <span class="punctuation">(</span> <span class="name">stderr</span>
<span class="ln"> 74 </span>            <span class="punctuation">,</span> <span class="literal string">&quot;warning: lex_line4: control flow is undefined for input&quot;</span>
<span class="ln"> 75 </span>                <span class="literal string">&quot; at position %ld, rerun re2c with '-W'</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span>
<span class="ln"> 76 </span>            <span class="punctuation">,</span> <span class="name">pos</span>
<span class="ln"> 77 </span>            <span class="punctuation">);</span>
<span class="ln"> 78 </span>    <span class="punctuation">}</span>
<span class="ln"> 79 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">len_act</span> <span class="operator">==</span> <span class="name">len_exp</span> <span class="operator">&amp;&amp;</span> <span class="name">rule_act</span> <span class="operator">==</span> <span class="name">rule_exp</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln"> 80 </span>        <span class="keyword">const</span> <span class="name">YYKEYTYPE</span> <span class="name">offset</span> <span class="operator">=</span> <span class="name">keys</span><span class="punctuation">[</span><span class="literal number integer">3</span> <span class="operator">*</span> <span class="name">i</span><span class="punctuation">];</span>
<span class="ln"> 81 </span>        <span class="operator">*</span><span class="name">cursor</span> <span class="operator">=</span> <span class="name">token</span> <span class="operator">+</span> <span class="name">offset</span><span class="punctuation">;</span>
<span class="ln"> 82 </span>        <span class="keyword">return</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln"> 83 </span>    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
<span class="ln"> 84 </span>        <span class="name">fprintf</span>
<span class="ln"> 85 </span>            <span class="punctuation">(</span> <span class="name">stderr</span>
<span class="ln"> 86 </span>            <span class="punctuation">,</span> <span class="literal string">&quot;error: lex_line4: at position %ld (iteration %u):</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span>
<span class="ln"> 87 </span>                <span class="literal string">&quot;</span><span class="literal string escape">\t</span><span class="literal string">expected: match length %ld, rule %u</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span>
<span class="ln"> 88 </span>                <span class="literal string">&quot;</span><span class="literal string escape">\t</span><span class="literal string">actual:   match length %ld, rule %u</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span>
<span class="ln"> 89 </span>            <span class="punctuation">,</span> <span class="name">pos</span>
<span class="ln"> 90 </span>            <span class="punctuation">,</span> <span class="name">i</span>
<span class="ln"> 91 </span>            <span class="punctuation">,</span> <span class="name">len_exp</span>
<span class="ln"> 92 </span>            <span class="punctuation">,</span> <span class="name">rule_exp</span>
<span class="ln"> 93 </span>            <span class="punctuation">,</span> <span class="name">len_act</span>
<span class="ln"> 94 </span>            <span class="punctuation">,</span> <span class="name">rule_act</span>
<span class="ln"> 95 </span>            <span class="punctuation">);</span>
<span class="ln"> 96 </span>        <span class="keyword">return</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln"> 97 </span>    <span class="punctuation">}</span>
<span class="ln"> 98 </span><span class="punctuation">}</span>
<span class="ln"> 99 </span>
<span class="ln">100 </span><span class="keyword type">int</span> <span class="name function">lex_line4</span><span class="punctuation">()</span>
<span class="ln">101 </span><span class="punctuation">{</span>
<span class="ln">102 </span>    <span class="keyword">const</span> <span class="keyword type">size_t</span> <span class="name">padding</span> <span class="operator">=</span> <span class="literal number integer">2</span><span class="punctuation">;</span> <span class="comment multiline">/* YYMAXFILL */</span>
<span class="ln">103 </span>    <span class="keyword type">int</span> <span class="name">status</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">104 </span>    <span class="keyword type">size_t</span> <span class="name">input_len</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">105 </span>    <span class="keyword type">size_t</span> <span class="name">keys_count</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">106 </span>    <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">input</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">107 </span>    <span class="name">YYKEYTYPE</span> <span class="operator">*</span><span class="name">keys</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">108 </span>    <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">cursor</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">109 </span>    <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">limit</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">110 </span>    <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">token</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">111 </span>    <span class="keyword">const</span> <span class="name">YYCTYPE</span> <span class="operator">*</span><span class="name">eof</span> <span class="operator">=</span> <span class="name builtin">NULL</span><span class="punctuation">;</span>
<span class="ln">112 </span>    <span class="keyword type">unsigned</span> <span class="keyword type">int</span> <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">113 </span>
<span class="ln">114 </span>    <span class="name">input</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">YYCTYPE</span> <span class="operator">*</span><span class="punctuation">)</span> <span class="name">read_file</span>
<span class="ln">115 </span>        <span class="punctuation">(</span><span class="literal string">&quot;example.c.line4.input&quot;</span>
<span class="ln">116 </span>        <span class="punctuation">,</span> <span class="keyword">sizeof</span> <span class="punctuation">(</span><span class="name">YYCTYPE</span><span class="punctuation">)</span>
<span class="ln">117 </span>        <span class="punctuation">,</span> <span class="name">padding</span>
<span class="ln">118 </span>        <span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">input_len</span>
<span class="ln">119 </span>        <span class="punctuation">);</span>
<span class="ln">120 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">input</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">121 </span>        <span class="name">status</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">122 </span>        <span class="keyword">goto</span> <span class="name">end</span><span class="punctuation">;</span>
<span class="ln">123 </span>    <span class="punctuation">}</span>
<span class="ln">124 </span>
<span class="ln">125 </span>    <span class="name">keys</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">YYKEYTYPE</span> <span class="operator">*</span><span class="punctuation">)</span> <span class="name">read_file</span>
<span class="ln">126 </span>        <span class="punctuation">(</span><span class="literal string">&quot;example.c.line4.keys&quot;</span>
<span class="ln">127 </span>        <span class="punctuation">,</span> <span class="literal number integer">3</span> <span class="operator">*</span> <span class="keyword">sizeof</span> <span class="punctuation">(</span><span class="name">YYKEYTYPE</span><span class="punctuation">)</span>
<span class="ln">128 </span>        <span class="punctuation">,</span> <span class="literal number integer">0</span>
<span class="ln">129 </span>        <span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">keys_count</span>
<span class="ln">130 </span>        <span class="punctuation">);</span>
<span class="ln">131 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">keys</span> <span class="operator">==</span> <span class="name builtin">NULL</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">132 </span>        <span class="name">status</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">133 </span>        <span class="keyword">goto</span> <span class="name">end</span><span class="punctuation">;</span>
<span class="ln">134 </span>    <span class="punctuation">}</span>
<span class="ln">135 </span>
<span class="ln">136 </span>    <span class="name">cursor</span> <span class="operator">=</span> <span class="name">input</span><span class="punctuation">;</span>
<span class="ln">137 </span>    <span class="name">limit</span> <span class="operator">=</span> <span class="name">input</span> <span class="operator">+</span> <span class="name">input_len</span> <span class="operator">+</span> <span class="name">padding</span><span class="punctuation">;</span>
<span class="ln">138 </span>    <span class="name">eof</span> <span class="operator">=</span> <span class="name">input</span> <span class="operator">+</span> <span class="name">input_len</span><span class="punctuation">;</span>
<span class="ln">139 </span>
<span class="ln">140 </span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">status</span> <span class="operator">==</span> <span class="literal number integer">0</span> <span class="operator">&amp;&amp;</span> <span class="name">i</span> <span class="operator">&lt;</span> <span class="name">keys_count</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">i</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">141 </span>        <span class="name">token</span> <span class="operator">=</span> <span class="name">cursor</span><span class="punctuation">;</span>
<span class="ln">142 </span>        <span class="name">YYCTYPE</span> <span class="name">yych</span><span class="punctuation">;</span>
<span class="ln">143 </span>
<span class="ln">144 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">YYLESSTHAN</span> <span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">))</span> <span class="name">YYFILL</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="ln">145 </span>        <span class="name">yych</span> <span class="operator">=</span> <span class="name">YYPEEK</span> <span class="punctuation">();</span>
<span class="ln">146 </span>        <span class="keyword">switch</span> <span class="punctuation">(</span><span class="name">yych</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">147 </span>        <span class="keyword">case</span> <span class="literal string char">'0'</span><span class="operator">:</span>
<span class="ln">148 </span>        <span class="keyword">case</span> <span class="literal string char">'1'</span><span class="operator">:</span>
<span class="ln">149 </span>        <span class="keyword">case</span> <span class="literal string char">'2'</span><span class="operator">:</span>
<span class="ln">150 </span>        <span class="keyword">case</span> <span class="literal string char">'3'</span><span class="operator">:</span>
<span class="ln">151 </span>        <span class="keyword">case</span> <span class="literal string char">'4'</span><span class="operator">:</span>
<span class="ln">152 </span>        <span class="keyword">case</span> <span class="literal string char">'5'</span><span class="operator">:</span>
<span class="ln">153 </span>        <span class="keyword">case</span> <span class="literal string char">'6'</span><span class="operator">:</span>
<span class="ln">154 </span>        <span class="keyword">case</span> <span class="literal string char">'7'</span><span class="operator">:</span>
<span class="ln">155 </span>        <span class="keyword">case</span> <span class="literal string char">'8'</span><span class="operator">:</span>
<span class="ln">156 </span>        <span class="keyword">case</span> <span class="literal string char">'9'</span><span class="operator">:</span>
<span class="ln">157 </span>        <span class="keyword">case</span> <span class="literal string char">'A'</span><span class="operator">:</span>
<span class="ln">158 </span>        <span class="keyword">case</span> <span class="literal string char">'B'</span><span class="operator">:</span>
<span class="ln">159 </span>        <span class="keyword">case</span> <span class="literal string char">'C'</span><span class="operator">:</span>
<span class="ln">160 </span>        <span class="keyword">case</span> <span class="literal string char">'D'</span><span class="operator">:</span>
<span class="ln">161 </span>        <span class="keyword">case</span> <span class="literal string char">'E'</span><span class="operator">:</span>
<span class="ln">162 </span>        <span class="keyword">case</span> <span class="literal string char">'F'</span><span class="operator">:</span>
<span class="ln">163 </span>        <span class="keyword">case</span> <span class="literal string char">'a'</span><span class="operator">:</span>
<span class="ln">164 </span>        <span class="keyword">case</span> <span class="literal string char">'b'</span><span class="operator">:</span>
<span class="ln">165 </span>        <span class="keyword">case</span> <span class="literal string char">'c'</span><span class="operator">:</span>
<span class="ln">166 </span>        <span class="keyword">case</span> <span class="literal string char">'d'</span><span class="operator">:</span>
<span class="ln">167 </span>        <span class="keyword">case</span> <span class="literal string char">'e'</span><span class="operator">:</span>
<span class="ln">168 </span>        <span class="keyword">case</span> <span class="literal string char">'f'</span><span class="operator">:</span>    <span class="keyword">goto</span> <span class="name">yy4</span><span class="punctuation">;</span>
<span class="ln">169 </span>        <span class="keyword">default</span><span class="operator">:</span>    <span class="keyword">goto</span> <span class="name">yy2</span><span class="punctuation">;</span>
<span class="ln">170 </span>        <span class="punctuation">}</span>
<span class="ln">171 </span><span class="name label">yy2</span><span class="punctuation">:</span>
<span class="ln">172 </span>        <span class="name">YYSKIP</span> <span class="punctuation">();</span>
<span class="ln">173 </span><span class="name label">yy3</span><span class="punctuation">:</span>
<span class="ln">174 </span>        <span class="name">status</span> <span class="operator">=</span> <span class="name">action_line4</span><span class="punctuation">(</span><span class="name">i</span><span class="punctuation">,</span> <span class="name">keys</span><span class="punctuation">,</span> <span class="name">input</span><span class="punctuation">,</span> <span class="name">token</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">cursor</span><span class="punctuation">,</span> <span class="literal number integer">254</span><span class="punctuation">);</span>
<span class="ln">175 </span>        <span class="keyword">continue</span><span class="punctuation">;</span>
<span class="ln">176 </span><span class="name label">yy4</span><span class="punctuation">:</span>
<span class="ln">177 </span>        <span class="name">YYSKIP</span> <span class="punctuation">();</span>
<span class="ln">178 </span>        <span class="name">yych</span> <span class="operator">=</span> <span class="name">YYPEEK</span> <span class="punctuation">();</span>
<span class="ln">179 </span>        <span class="keyword">switch</span> <span class="punctuation">(</span><span class="name">yych</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">180 </span>        <span class="keyword">case</span> <span class="literal string char">'0'</span><span class="operator">:</span>
<span class="ln">181 </span>        <span class="keyword">case</span> <span class="literal string char">'1'</span><span class="operator">:</span>
<span class="ln">182 </span>        <span class="keyword">case</span> <span class="literal string char">'2'</span><span class="operator">:</span>
<span class="ln">183 </span>        <span class="keyword">case</span> <span class="literal string char">'3'</span><span class="operator">:</span>
<span class="ln">184 </span>        <span class="keyword">case</span> <span class="literal string char">'4'</span><span class="operator">:</span>
<span class="ln">185 </span>        <span class="keyword">case</span> <span class="literal string char">'5'</span><span class="operator">:</span>
<span class="ln">186 </span>        <span class="keyword">case</span> <span class="literal string char">'6'</span><span class="operator">:</span>
<span class="ln">187 </span>        <span class="keyword">case</span> <span class="literal string char">'7'</span><span class="operator">:</span>
<span class="ln">188 </span>        <span class="keyword">case</span> <span class="literal string char">'8'</span><span class="operator">:</span>
<span class="ln">189 </span>        <span class="keyword">case</span> <span class="literal string char">'9'</span><span class="operator">:</span>
<span class="ln">190 </span>        <span class="keyword">case</span> <span class="literal string char">'A'</span><span class="operator">:</span>
<span class="ln">191 </span>        <span class="keyword">case</span> <span class="literal string char">'B'</span><span class="operator">:</span>
<span class="ln">192 </span>        <span class="keyword">case</span> <span class="literal string char">'C'</span><span class="operator">:</span>
<span class="ln">193 </span>        <span class="keyword">case</span> <span class="literal string char">'D'</span><span class="operator">:</span>
<span class="ln">194 </span>        <span class="keyword">case</span> <span class="literal string char">'E'</span><span class="operator">:</span>
<span class="ln">195 </span>        <span class="keyword">case</span> <span class="literal string char">'F'</span><span class="operator">:</span>
<span class="ln">196 </span>        <span class="keyword">case</span> <span class="literal string char">'a'</span><span class="operator">:</span>
<span class="ln">197 </span>        <span class="keyword">case</span> <span class="literal string char">'b'</span><span class="operator">:</span>
<span class="ln">198 </span>        <span class="keyword">case</span> <span class="literal string char">'c'</span><span class="operator">:</span>
<span class="ln">199 </span>        <span class="keyword">case</span> <span class="literal string char">'d'</span><span class="operator">:</span>
<span class="ln">200 </span>        <span class="keyword">case</span> <span class="literal string char">'e'</span><span class="operator">:</span>
<span class="ln">201 </span>        <span class="keyword">case</span> <span class="literal string char">'f'</span><span class="operator">:</span>    <span class="keyword">goto</span> <span class="name">yy5</span><span class="punctuation">;</span>
<span class="ln">202 </span>        <span class="keyword">default</span><span class="operator">:</span>    <span class="keyword">goto</span> <span class="name">yy3</span><span class="punctuation">;</span>
<span class="ln">203 </span>        <span class="punctuation">}</span>
<span class="ln">204 </span><span class="name label">yy5</span><span class="punctuation">:</span>
<span class="ln">205 </span>        <span class="name">YYSKIP</span> <span class="punctuation">();</span>
<span class="ln">206 </span>        <span class="name">status</span> <span class="operator">=</span> <span class="name">action_line4</span><span class="punctuation">(</span><span class="name">i</span><span class="punctuation">,</span> <span class="name">keys</span><span class="punctuation">,</span> <span class="name">input</span><span class="punctuation">,</span> <span class="name">token</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">cursor</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">);</span>
<span class="ln">207 </span>        <span class="keyword">continue</span><span class="punctuation">;</span>
<span class="ln">208 </span>
<span class="ln">209 </span>    <span class="punctuation">}</span>
<span class="ln">210 </span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">status</span> <span class="operator">==</span> <span class="literal number integer">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">211 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">cursor</span> <span class="operator">!=</span> <span class="name">eof</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">212 </span>            <span class="name">status</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">213 </span>            <span class="keyword">const</span> <span class="keyword type">long</span> <span class="name">pos</span> <span class="operator">=</span> <span class="name">token</span> <span class="operator">-</span> <span class="name">input</span><span class="punctuation">;</span>
<span class="ln">214 </span>            <span class="name">fprintf</span><span class="punctuation">(</span><span class="name">stderr</span><span class="punctuation">,</span> <span class="literal string">&quot;error: lex_line4: unused input strings left at position %ld</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">,</span> <span class="name">pos</span><span class="punctuation">);</span>
<span class="ln">215 </span>        <span class="punctuation">}</span>
<span class="ln">216 </span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">i</span> <span class="operator">!=</span> <span class="name">keys_count</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">217 </span>            <span class="name">status</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">218 </span>            <span class="name">fprintf</span><span class="punctuation">(</span><span class="name">stderr</span><span class="punctuation">,</span> <span class="literal string">&quot;error: lex_line4: unused keys left after %u iterations</span><span class="literal string escape">\n</span><span class="literal string">&quot;</span><span class="punctuation">,</span> <span class="name">i</span><span class="punctuation">);</span>
<span class="ln">219 </span>        <span class="punctuation">}</span>
<span class="ln">220 </span>    <span class="punctuation">}</span>
<span class="ln">221 </span>
<span class="ln">222 </span><span class="name label">end</span><span class="punctuation">:</span>
<span class="ln">223 </span>    <span class="name">free</span><span class="punctuation">(</span><span class="name">input</span><span class="punctuation">);</span>
<span class="ln">224 </span>    <span class="name">free</span><span class="punctuation">(</span><span class="name">keys</span><span class="punctuation">);</span>
<span class="ln">225 </span>
<span class="ln">226 </span>    <span class="keyword">return</span> <span class="name">status</span><span class="punctuation">;</span>
<span class="ln">227 </span><span class="punctuation">}</span>
<span class="ln">228 </span>
<span class="ln">229 </span><span class="comment preproc">#undef YYCTYPE
</span><span class="ln">230 </span><span class="comment preproc">#undef YYKEYTYPE
</span><span class="ln">231 </span><span class="comment preproc">#undef YYPEEK
</span><span class="ln">232 </span><span class="comment preproc">#undef YYSKIP
</span><span class="ln">233 </span><span class="comment preproc">#undef YYLESSTHAN
</span><span class="ln">234 </span><span class="comment preproc">#undef YYFILL
</span><span class="ln">235 </span><span class="comment preproc"></span>
<span class="ln">236 </span><span class="keyword type">int</span> <span class="name function">main</span><span class="punctuation">()</span>
<span class="ln">237 </span><span class="punctuation">{</span>
<span class="ln">238 </span>    <span class="keyword">if</span><span class="punctuation">(</span><span class="name">lex_line4</span><span class="punctuation">()</span> <span class="operator">!=</span> <span class="literal number integer">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
<span class="ln">239 </span>        <span class="keyword">return</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="ln">240 </span>    <span class="punctuation">}</span>
<span class="ln">241 </span>    <span class="keyword">return</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
<span class="ln">242 </span><span class="punctuation">}</span>
</pre>
<p>re2c generated two auxilary functions: <tt class="docutils literal">read_file</tt> and <tt class="docutils literal">action_line4</tt>.
<tt class="docutils literal">read_file</tt> is used to map <tt class="docutils literal">.input</tt> and <tt class="docutils literal">.keys</tt> files into memory (this function is shared between all lexers).
<tt class="docutils literal">action_line4</tt> is a replacement for actions: it compares actual lexing results with the expected results.
This function is specific to each lexer.
Lexing is done by <tt class="docutils literal">lex_line4</tt>: this function contains the generated DFA.
<tt class="docutils literal">main</tt> simply calls the lexer.</p>
<p>Compile and run:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>gcc -o example example.c
<span class="name variable">$ </span>./example
<span class="name variable">$ </span><span class="name builtin">echo</span> <span class="name variable">$?</span>
0
</pre>
<p>When everything is fine, the program outputs nothing and exits with zero.</p>
</div>
<div class="section" id="failures">
<h1>Failures</h1>
<p>Skeleton's main purpose was to find and prevent errors in re2c code generation (which it did).
I don't have a ready example of failure (otherwise I would have fixed re2c),
but we can trigger various errors by alternating the generated program, input and keys.</p>
<div class="section" id="artificial-examples">
<h2>Artificial examples</h2>
<p>Let's take the first key in <tt class="docutils literal">example.c.line4.keys</tt>  (bytes <tt class="docutils literal">0x01</tt>, <tt class="docutils literal">0x01</tt> and <tt class="docutils literal">0xFE</tt>) and mangle it in various ways.
For example, let's change the first byte (length of current input string) to <tt class="docutils literal">0xFF</tt>:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -S -o example.c hex2.re
<span class="name variable">$ </span>sed -i -e <span class="literal string single">'s/\x01\x01\xfe/\xff\x01\xfe/'</span> example.c.line4.keys
<span class="name variable">$ </span>./example
error: lex_line4: unused input strings left at position 255
error: lex_line4: unused keys left after <span class="literal number">1</span> iterations
</pre>
<p>Lexer complains about unused keys and input strings.
The alternated parameter controls offset of the next string:
lexer was forced to jump past the end of input.
Now let's alter the second byte (length of the matching prefix):</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -S -o example.c hex2.re
<span class="name variable">$ </span>sed -i -e <span class="literal string single">'s/\x01\x01\xfe/\x01\x03\xfe/'</span> example.c.line4.keys
<span class="name variable">$ </span>./example
error: lex_line4: at position <span class="literal number">0</span> <span class="operator">(</span>iteration 0<span class="operator">)</span>:
        expected: match length 3, rule 254
        actual:   match length 1, rule 254
</pre>
<p>Third byte stands for rule number:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -S -o example.c hex2.re
<span class="name variable">$ </span>sed -i -e <span class="literal string single">'s/\x01\x01\xfe/\x01\x01\xfd/'</span> example.c.line4.keys
<span class="name variable">$ </span>./example
error: lex_line4: at position <span class="literal number">0</span> <span class="operator">(</span>iteration 0<span class="operator">)</span>:
        expected: match length 1, rule 253
        actual:   match length 1, rule 254
</pre>
<p>Now let's change the input string:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -S -o example.c hex2.re
<span class="name variable">$ </span>sed -i -e <span class="literal string single">'s/&#64;/00/'</span> example.c.line4.input
<span class="name variable">$ </span>./example
error: lex_line4: at position <span class="literal number">3</span> <span class="operator">(</span>iteration 3<span class="operator">)</span>:
        expected: match length 1, rule 254
        actual:   match length 2, rule 0
</pre>
<p>And so on.
Of course, some errors won't be captured by skeleton program: it's not feasible to cover all possible inputs.
For example, of all the hex digits <tt class="docutils literal"><span class="pre">[0-9a-fA-F]</span></tt> re2c uses only <tt class="docutils literal">[09afAF]</tt>:
we can mangle the lexer to not to recognize <tt class="docutils literal"><span class="pre">[1-8b-eB-E]</span></tt> as hex digits and the program won't notice.
However, the chosen values are the boundaries of disjoint character ranges and they are tested extensively
(see the section about data generation for details).</p>
</div>
<div class="section" id="undefined-control-flow">
<h2>Undefined control flow</h2>
<p>One special case of failure is caused by undefined control flow in the generated lexer.
Suppose, for example, that we forgot to handle default case in the example above:</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span><span class="comment multiline">/*!re2c
</span><span class="ln">2 </span><span class="comment multiline">    [0-9a-fA-F]{2} {}
</span><span class="ln">3 </span><span class="comment multiline">*/</span>
</pre>
<p>In this case re2c generates code that is perfectly correct,
but because of the undefined control flow skeleton program fails:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -S -o example.c hex2.re
<span class="name variable">$ </span>gcc -o example example.c
<span class="name variable">$ </span>./example
warning: lex_line3: control flow is undefined <span class="keyword">for</span> input at position 72, rerun re2c with <span class="literal string single">'-W'</span>
error: lex_line3: at position <span class="literal number">72</span> <span class="operator">(</span>iteration 36<span class="operator">)</span>:
        expected: match length 0, rule 255
        actual:   match length 3, rule 0
</pre>
<p>In this case we are lucky: lexer erroneously hit an action and was terminated.
We got a nice error and a warning that suggests that we should rerun re2c with <tt class="docutils literal"><span class="pre">-W</span></tt>:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>re2c -W -S -o example.c hex2.re
re2c: warning: line 3: control flow is undefined <span class="keyword">for</span> strings that match
        <span class="literal string single">'[\x0-\x2F\x3A-\x40\x47-\x60\x67-\xFF]'</span>
        <span class="literal string single">'[\x30-\x39\x41-\x46\x61-\x66] [\x0-\x2F\x3A-\x40\x47-\x60\x67-\xFF]'</span>
, use default rule <span class="literal string single">'*'</span> <span class="operator">[</span>-Wundefined-control-flow<span class="operator">]</span>
</pre>
<p>However, it could be much worse: segfault or eternal loop.
One thing is for sure: the generated input would have triggered undefined control flow anyway.</p>
</div>
</div>
<div class="section" id="generating-data">
<h1>Generating data</h1>
<p>One cannot just run lexer on all possible inputs:
for an alphabet of <tt class="docutils literal">n</tt> characters and input length <tt class="docutils literal">m</tt>, the number of input strings is <tt class="docutils literal">n</tt> to the power of <tt class="docutils literal">m</tt>.</p>
<p>The problem can be mitigated by tailoring the set of input strings to a particular lexer.
For most lexers only a small subset of all input strings makes sense: the majority of them are ill-formed.
Ill-formed inputs are rejected after the first few characters, so that remaining characters are insignificant:
lexer will never reach them and they can be as well discarded.
Input strings that differ only in discarded suffixes are collapsed into one.
This reduces the overall number of strings greatly.</p>
<p>Still the number of inputs is too large.
We can further reduce it by collapsing disjoint character sets:
for each each character range we only take its boundaries.
This cuts off many interesting well-formed inputs, but we have to give up some of them this way or another.
The graph from the example above results into the following residual DFA:</p>
<img alt="collapsed.png" src="collapsed.png" style="width: 90%;" />
<p>All further algorithms work with the residual graph.
re2c has two algorithms:</p>
<ul class="simple">
<li>First algorithm generates all possible paths from start node to end nodes
by performing deep-first search on graph (loops are iterated once).
The number of input strings grows exponentially with the number of edges,
thus the algorithm is only suitable for small graphs and graphs with loosely connected nodes.</li>
<li>Second algoritm constructs path cover: a set of paths from start node to end nodes
such that each edge in graph is covered by at least one path.
The number of generated strings is bounded by the number of edges in graph.
However, the total length of the generated strings depends quadratically on the number of edges.
(An example of quadratic dependency is shown below.
Upper bound follows from the fact that total length cannot exceed the number of strings
times maximal string length, both values obviously bounded by the number of edges.)</li>
</ul>
<p>re2c proceeds as follows: first, it estimates the amount of data needed to generate all paths
(estimation can be done in linear time).
If it exceeds certain limit (~32Mb edges), re2c fallbacks to path cover (which is limited by ~1Gb of edges).
Both algorithms are implemented so that they consume constant amount of RAM
(they dump data to file as soon as it is generated).</p>
<p>We can look at both algorithms in action on the same example, simply alternating repetition counter:</p>
<pre class="code cpp literal-block">
<span class="ln">1 </span><span class="comment multiline">/*!re2c
</span><span class="ln">2 </span><span class="comment multiline">    *              {}
</span><span class="ln">3 </span><span class="comment multiline">    [0-9a-fA-F]{1} {} // [0-9a-fA-F]{2}, [0-9a-fA-F]{3}, [0-9a-fA-F]{4}, ...
</span><span class="ln">4 </span><span class="comment multiline">*/</span>
</pre>
<p>Each increment of the repetition counter adds 14 new edges to the residual DFA.
For example, here is a picture of DFA with three repetitions
(compare it with the above picture of two repetitions â€” edges in bold have been added):</p>
<img alt="collapsed_next.png" src="collapsed_next.png" style="width: 60%;" />
<p>The following script shows how <tt class="docutils literal">.input</tt> and <tt class="docutils literal">.keys</tt> file size depends on the number of edges in graph:</p>
<p><a class="reference external" href="gen.sh">[gen.sh]</a></p>
<pre class="code bash literal-block">
<span class="ln">1 </span><span class="name builtin">printf</span> <span class="literal string double">&quot;%10s%10s%10s%10s\n\n&quot;</span> iters edges input keys
<span class="ln">2 </span><span class="keyword">for</span> i in <span class="literal string backtick">`</span>seq <span class="name variable">$1</span> <span class="name variable">$2</span><span class="literal string backtick">`</span>
<span class="ln">3 </span><span class="keyword">do</span>
<span class="ln">4 </span>    <span class="name builtin">echo</span> <span class="literal string single">'/*!re2c * {} [0-9a-fA-F]{'</span><span class="name variable">$i</span><span class="literal string single">'} {} */'</span> <span class="punctuation">|</span> re2c -S -o example.c -
<span class="ln">5 </span>    <span class="name variable">input</span><span class="operator">=</span><span class="literal string backtick">`</span>stat -c <span class="literal string single">'%s'</span> example.c.line1.input<span class="literal string backtick">`</span>
<span class="ln">6 </span>    <span class="name variable">keys</span><span class="operator">=</span><span class="literal string backtick">`</span>stat -c <span class="literal string single">'%s'</span> example.c.line1.keys<span class="literal string backtick">`</span>
<span class="ln">7 </span>    <span class="name builtin">printf</span> <span class="literal string double">&quot;%10d%10d%10d%10d\n&quot;</span> <span class="name variable">$i</span> <span class="keyword">$((</span><span class="literal number">14</span> <span class="operator">*</span> i<span class="keyword">))</span> <span class="name variable">$input</span> <span class="name variable">$keys</span>
<span class="ln">8 </span><span class="keyword">done</span>
</pre>
<p>It expects two arguments: lower and upped bounds of the iteration counter.
From the example output we can see that for counter values 1 through 7 re2c generated all paths,
then it switched to path cover:</p>
<pre class="code literal-block">
$ ./gen.sh 1 16
     iters     edges     input      keys

         1        14        14        42
         2        28       176       276
         3        42      1616      1680
         4        56     13064     10104
         5        70     98600     60648
         6        84    712904    363912
         7        98   5005256   2183496
         8       112       336       210
         9       126       414       234
        10       140       500       258
        11       154       594       282
        12       168       696       306
        13       182       806       330
        14       196       924       354
        15       210      1050       378
        16       224      1184       402
</pre>
<p>The following pictures show how <tt class="docutils literal">.keys</tt> file size depends on the number of edges.
Total size of keys equals size of a single key times the number of generated strings.
On the 1st plot (repetitions 1 through 7) it grows exponentially.
On the 2nd plot (repetitions 8 through 1024) it grows linearly (the change of angle
is due to the change of key size: starting from repetition count 256 path length gets out of 1-byte range).
The 3rd plot shows the relation between 1st and 2nd plots.</p>
<img alt="plot_keys.png" src="plot_keys.png" style="width: 100%;" />
<p>Size of <tt class="docutils literal">.input</tt> grows exponentially (repetitions 1 through 7) and quadratically (repetitions 8 through 1024).
The exact quadratic function is <tt class="docutils literal">f(x) = 4x^2+ 10x</tt>, where <tt class="docutils literal">x</tt> is the repetition counter.
However, graphs like this rarely occur in practice: maximal path length is usually less than a hundred.</p>
<img alt="plot_input.png" src="plot_input.png" style="width: 100%;" />
</div>
<div class="section" id="use">
<h1>Use</h1>
<div class="section" id="code-verification">
<h2>Code verification</h2>
<p>When re2c transforms regular expressions to code, it uses several internal representations:</p>
<ol class="arabic simple">
<li>Regular expressions are parsed and transformed into abstract syntax tree (AST).</li>
<li>AST is compiled to bytecode.</li>
<li>Bytecode is used to construct deterministic finite automaton (DFA).</li>
<li>DFA undergoes some transformations.</li>
<li>Transformed DFA is compiled to C/C++ code.</li>
</ol>
<p>Skeleton is constructed right after stage 3, before any additional changes have been made to DFA.
Skeleton is in fact a simplified copy of DFA (better suited for deriving data and freed of all irrelevant information).
It is used only to generate <tt class="docutils literal">.input</tt> and <tt class="docutils literal">.keys</tt> files.
The rest of skeleton program is the usual re2c-generated code:
<tt class="docutils literal"><span class="pre">-S,</span> <span class="pre">--skeleton</span></tt> option only resets environment bindings, but does not affect any code generation decisions.</p>
<p>Skeleton programs are therefore capable of catching various errors in code generation.
In other words, it is much safer to rebalance nested <tt class="docutils literal">if</tt> statements,
add some novel dispatch mechanism, apply various code deduplication or inlining optimizations
and otherwise reorganize and tweak the generated code.</p>
</div>
<div class="section" id="benchmarks">
<h2>Benchmarks</h2>
<p>Another direct application of skeleton is benchmarking.
There is no need to construct benchmarks by hand: re2c automatically converts any real-world program
to a ready benchmark and provides input data.
One only needs to measure execution time of the generated program
(and perhaps adjust it by running the main loop multiple times).</p>
</div>
<div class="section" id="executable-specs">
<h2>Executable specs</h2>
<p>Because of the fact that skeleton ignores all non-re2c code (including actions),
skeleton programs don't need any additional code.
One can just sketch a regular expression specification
and immediately get an executable program.</p>
</div>
</div>
</div>
<div class="footer">
<hr class="footer" />
<a class="reference external" href="../../../index.html">[home]</a> <a class="reference external" href="../../manual.html">[Manual]</a> <a class="reference external" href="../features.html">[Features]</a>
</div>
</body>
</html>
