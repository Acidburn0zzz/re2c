
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>[-Wcondition-order] &#8212; re2c 1.1.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/theme-re2c.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="alternate" type="application/atom+xml" href="../../../feed/atom.xml" title="Atom 1.0" />
    
 
  </head>
  <body>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="re2c-logo">
    re2c-1.1.1
</div>

<h3><a href="../../../index.html">Home</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Install</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../manual.html">Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../options/options.html">Options</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../warnings.html">Warnings</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../undefined_control_flow/wundefined_control_flow.html">[-Wundefined-control-flow]</a></li>
<li class="toctree-l3"><a class="reference internal" href="../unreachable_rules/wunreachable_rules.html">[-Wunreachable-rules]</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">[-Wcondition-order]</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-simple-example">A simple example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-it-works">How it works</a></li>
<li class="toctree-l4"><a class="reference internal" href="#real-world-examples">Real-world examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../useless_escape/wuseless_escape.html">[-Wuseless-escape]</a></li>
<li class="toctree-l3"><a class="reference internal" href="../swapped_range/wswapped_range.html">[-Wswapped-range]</a></li>
<li class="toctree-l3"><a class="reference internal" href="../empty_character_class/wempty_character_class.html">[-Wempty-character-class]</a></li>
<li class="toctree-l3"><a class="reference internal" href="../match_empty_string/wmatch_empty_string.html">[-Wmatch-empty-string]</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../syntax/syntax.html">Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../features/features.html">Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../news/news.html">News</a></li>
</ul>

    <h3>[-Wcondition-order]</h3>
    <div class="re2c-toc-local">
        <ul>
<li><a class="reference internal" href="#">[-Wcondition-order]</a><ul>
<li><a class="reference internal" href="#a-simple-example">A simple example</a></li>
<li><a class="reference internal" href="#how-it-works">How it works</a></li>
<li><a class="reference internal" href="#real-world-examples">Real-world examples</a></li>
</ul>
</li>
</ul>

    </div>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="wcondition-order">
<h1>[-Wcondition-order]<a class="headerlink" href="#wcondition-order" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="a-simple-example">
<h2>A simple example<a class="headerlink" href="#a-simple-example" title="Permalink to this headline">¶</a></h2>
<p>The following lexer consists of two conditions: <code class="docutils literal"><span class="pre">a</span></code> and <code class="docutils literal"><span class="pre">b</span></code>.
It starts in condition <code class="docutils literal"><span class="pre">a</span></code>, which expects a sequence of letters <code class="docutils literal"><span class="pre">'a'</span></code> followed by a comma.
The comma causes transition to condition <code class="docutils literal"><span class="pre">b</span></code>, which expects a sequence of letters <code class="docutils literal"><span class="pre">'b'</span></code> followed by an exclamation mark.
Anything else is an error.
Nothing special, except that instead of generating condition names with the <code class="docutils literal"><span class="pre">/*!types:re2c*/</span></code> directive
or the <code class="docutils literal"><span class="pre">-t,</span> <span class="pre">--type-header</span></code> option, we’ve hardcoded them manually:</p>
<p><a class="reference download internal" href="../../../_downloads/wcondition_order.re.txt" download=""><code class="xref download docutils literal"><span class="pre">[wcondition_order.re]</span></code></a></p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="cp">#ifdef REVERSED_CONDITION_ORDER</span>
<span class="cp">#    define yyca 1</span>
<span class="cp">#    define yycb 0</span>
<span class="cp">#else</span>
<span class="cp">#    define yyca 0</span>
<span class="cp">#    define yycb 1</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">YYCURSOR</span> <span class="o">=</span> <span class="s">&quot;aaaa,bbb!&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">yyca</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="cm">/*!re2c</span>
<span class="cm">        re2c:define:YYCTYPE = char;</span>
<span class="cm">        re2c:yyfill:enable = 0;</span>
<span class="cm">        re2c:define:YYSETCONDITION = &quot;c = @@;&quot;;</span>
<span class="cm">        re2c:define:YYSETCONDITION:naked = 1;</span>
<span class="cm">        re2c:define:YYGETCONDITION = c;</span>
<span class="cm">        re2c:define:YYGETCONDITION:naked = 1;</span>

<span class="cm">        &lt;*&gt; * { printf (&quot;error\n&quot;); break; }</span>

<span class="cm">        &lt;a&gt; &quot;a&quot;      { printf (&quot;a&quot;); continue; }</span>
<span class="cm">        &lt;a&gt; &quot;,&quot; =&gt; b { printf (&quot;,&quot;); continue; }</span>

<span class="cm">        &lt;b&gt; &quot;!&quot; { printf (&quot;!\n&quot;); break; }</span>
<span class="cm">        &lt;b&gt; &quot;b&quot; { printf (&quot;b&quot;); continue; }</span>
<span class="cm">    */</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Condition order is controlled by the <code class="docutils literal"><span class="pre">REVERSED_CONDITION_ORDER</span></code> define.
Let’s compile and run it:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ re2c -c -o example.c -Wcondition-order wcondition_order.re
$
$ g++ -o example example.c
$ ./example
aaaa,bbb!
$
$ g++ -o example -DREVERSED_CONDITION_ORDER example.c
$ ./example
aaaa,bbb!
</pre></div>
</div>
<p>Everything works fine: we get <code class="docutils literal"><span class="pre">aaaa,bbb!</span></code> in both cases.
However, if we use the <code class="docutils literal"><span class="pre">-s</span></code> re2c option, the lexer becomes sensitive to condition order:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ re2c -cs -o example.c -Wcondition-order wcondition_order.re
re2c: warning: line 31: looks like you use hardcoded numbers instead of autogenerated condition names: better add
&#39;/*!types:re2c*/&#39; directive or &#39;-t, --type-header&#39; option and don&#39;t rely on fixed condition order. [-Wcondition-order]
$
$ g++ -o example example.c
$ ./example
aaaa,bbb!
$
$ g++ -o example -DREVERSED_CONDITION_ORDER example.c
$ ./example
error
</pre></div>
</div>
<p>And we also get a warning from re2c.
The same behavior (re2c warning and error with <code class="docutils literal"><span class="pre">-DREVERSED_CONDITION_ORDER</span></code>) remains if we use the <code class="docutils literal"><span class="pre">-g</span></code> option
(or any option that implies <code class="docutils literal"><span class="pre">-s</span></code> or <code class="docutils literal"><span class="pre">-g</span></code>).
Why is that?
A look at the generated code explains everything.
Normally the initial dispatch on conditions is a <code class="docutils literal"><span class="pre">switch</span></code> statement:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="nl">yyca</span><span class="p">:</span> <span class="k">goto</span> <span class="n">yyc_a</span><span class="p">;</span>
<span class="k">case</span> <span class="nl">yycb</span><span class="p">:</span> <span class="k">goto</span> <span class="n">yyc_b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dispatch uses explicit condition names and works no matter what numbers are assigned to them.
However, with the <code class="docutils literal"><span class="pre">-s</span></code> option, re2c generates an <code class="docutils literal"><span class="pre">if</span></code> statement instead of a <code class="docutils literal"><span class="pre">switch</span></code>:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">yyc_a</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">yyc_b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And with the <code class="docutils literal"><span class="pre">-g</span></code> option, it uses a jump table (computed <code class="docutils literal"><span class="pre">goto</span></code>):</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">yyctable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">&amp;&amp;</span><span class="n">yyc_a</span><span class="p">,</span>
        <span class="o">&amp;&amp;</span><span class="n">yyc_b</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">goto</span> <span class="o">*</span><span class="n">yyctable</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
</pre></div>
</div>
<p>Clearly, the last two cases are condition order sensitive .
The fix is easy: as the warning suggests, use the <code class="docutils literal"><span class="pre">/*!types:re2c*/</span></code> directive or the <code class="docutils literal"><span class="pre">-t,</span> <span class="pre">--type-header</span></code> option.</p>
</div>
<div class="section" id="how-it-works">
<h2>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>The warning is triggered if at the same time:</p>
<ul class="simple">
<li>Conditions are enabled with with <code class="docutils literal"><span class="pre">-c</span></code>.</li>
<li>Neither <code class="docutils literal"><span class="pre">/*!types:re2c*/</span></code> nor <code class="docutils literal"><span class="pre">-t,</span> <span class="pre">--type-header</span></code> is used.</li>
<li>The initial condition dispatch is sensitive to condition order:
it is either an <code class="docutils literal"><span class="pre">if</span></code> statement or a jump table.
Note that the number of conditions must be greater than one,
otherwise the dispatch shrinks to a simple unconditional jump.</li>
</ul>
</div>
<div class="section" id="real-world-examples">
<h2>Real-world examples<a class="headerlink" href="#real-world-examples" title="Permalink to this headline">¶</a></h2>
<p>The  best real-world example is the story of how <code class="docutils literal"><span class="pre">[-Wcondition-order]</span></code> was added to re2c.</p>
<p>One day I decided to change the condition numbering scheme.
It was only natural: re2c assigns numbers to conditions in the order they appear in the code.
This is not very convenient, because elsewhere in the code, condition names (not numbers) are used as unique identifiers.
Names are sorted lexicographically, so the original condition order is not preserved.
It takes extra care to remember the mapping of names to numbers.
So why not just drop numbers and sort conditions by their names?
No one cares for condition order anyway: since re2c-generated code uses condition names,
they must be defined, and why would anyone define them by hand if they can do it automatically.</p>
<p>Or wait.
Almost occasionally I found a real-world program that does use fixed condition numbers.
Here is the carcass of this program:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define NORMAL 0</span>
<span class="cp">#define PRE_RAW 1</span>
<span class="cp">#define RAW 2</span>
<span class="cp">#define INITIAL 3</span>

<span class="cm">/*!re2c</span>
<span class="cm">    re2c:yyfill:check = 0;</span>

<span class="cm">    T_TRUE      &#39;true&#39;</span>
<span class="cm">    T_YES       &#39;yes&#39;</span>
<span class="cm">    T_ON        &#39;on&#39;</span>
<span class="cm">    T_ENABLED   &#39;enabled&#39;</span>
<span class="cm">    T_FALSE     &#39;false&#39;</span>
<span class="cm">    T_NO        &#39;no&#39;</span>
<span class="cm">    T_OFF       &#39;off&#39;</span>
<span class="cm">    T_DISABLED  &#39;disabled&#39;</span>
<span class="cm">    T_EVAL      &#39;ev&#39;</span>
<span class="cm">    T_SHELL     &#39;sh&#39;</span>
<span class="cm">    T_IF        &#39;if&#39;</span>
<span class="cm">    T_RUN       &#39;run&#39;</span>
<span class="cm">    T_RUN_SHORT &quot;r&quot;</span>
<span class="cm">    WS          [ \r\n\t]+</span>
<span class="cm">    DIGITS      [-]?[0-9\.]+</span>
<span class="cm">    ID          [^ \r\n\t:#\000]+</span>
<span class="cm">    ADDR        [0][x][a-fA-F0-9]+</span>
<span class="cm">    OPCODE      (ZEND_|zend_)([A-Za-z])+</span>
<span class="cm">    INPUT       [^\n\000]+</span>

<span class="cm">    &lt;!*&gt; {}</span>
<span class="cm">    &lt;*&gt;{WS}?[\n\000] {}</span>
<span class="cm">    &lt;PRE_RAW, NORMAL&gt;[-][r]{WS}?{DIGITS} {}</span>
<span class="cm">    &lt;NORMAL&gt;{T_IF}{WS} {}</span>
<span class="cm">    &lt;NORMAL&gt;{ID}[:]{1}[//]{2} {}</span>
<span class="cm">    &lt;NORMAL&gt;[#]{1} {}</span>
<span class="cm">    &lt;NORMAL&gt;[:]{2} {}</span>
<span class="cm">    &lt;NORMAL&gt;[:]{1} {}</span>
<span class="cm">    &lt;NORMAL&gt;({T_YES}|{T_ON}|{T_ENABLED}|{T_TRUE}){WS} {}</span>
<span class="cm">    &lt;NORMAL&gt;({T_NO}|{T_OFF}|{T_DISABLED}|{T_FALSE}){WS} {}</span>
<span class="cm">    &lt;NORMAL&gt;{DIGITS} {}</span>
<span class="cm">    &lt;NORMAL&gt;{ADDR} {}</span>
<span class="cm">    &lt;NORMAL&gt;{OPCODE} {}</span>
<span class="cm">    &lt;NORMAL&gt;{ID} {}</span>
<span class="cm">    &lt;RAW&gt;{INPUT} {}</span>
<span class="cm">    &lt;*&gt;{WS} {}</span>
<span class="cm">    &lt;INITIAL&gt;{T_EVAL}{WS} {}</span>
<span class="cm">    &lt;INITIAL&gt;{T_SHELL}{WS} {}</span>
<span class="cm">    &lt;INITIAL&gt;({T_RUN}|{T_RUN_SHORT}){WS} {}</span>
<span class="cm">    &lt;PRE_RAW&gt;. {}</span>
<span class="cm">    &lt;INITIAL&gt;. {}</span>
<span class="cm">*/</span>
</pre></div>
</td></tr></table></div>
<p>Curiously, the program somehow avoids using re2c-generated condition names:
even <code class="docutils literal"><span class="pre">YYSETCONDITION</span></code> is called manually instead of using <code class="docutils literal"><span class="pre">=&gt;</span></code> in rules.
The program uses <code class="docutils literal"><span class="pre">-g</span></code> option, so the initial dispatch does depend on condition order:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">yyctable</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">&amp;&amp;</span><span class="n">yyc_NORMAL</span><span class="p">,</span>
    <span class="o">&amp;&amp;</span><span class="n">yyc_PRE_RAW</span><span class="p">,</span>
    <span class="o">&amp;&amp;</span><span class="n">yyc_RAW</span><span class="p">,</span>
    <span class="o">&amp;&amp;</span><span class="n">yyc_INITIAL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">goto</span> <span class="o">*</span><span class="n">yyctable</span><span class="p">[</span><span class="n">YYGETCONDITION</span><span class="p">()];</span>
</pre></div>
</div>
<p>Of course, re2c will keep to the old condition numbering scheme (at least in the nearest future).
Who wants to break the old code? <code class="docutils literal"><span class="pre">:)</span></code></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
      Last updated on Aug 30, 2018.
    </div>
  </body>
</html>